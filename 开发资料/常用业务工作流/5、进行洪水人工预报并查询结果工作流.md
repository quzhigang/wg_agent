
## 5. 进行洪水人工预报并查询结果工作流

**触发场景**：当用户询问流域、水库或水文站的未来洪水预报情况，且明确指明具体的降雨条件(如未来降雨100mm)，或直接指明进行一次新的人工预报时，或指明对历时某场降雨洪水进行预报时。

**对话示例**：
- "进行一次人工预报，告诉我流域的洪水预报结果"
- "新建一个人工预报方案，假设未来24小时降雨200mm，告诉我预报结果"
- "如果未来降雨100mm，告诉我XX水库预报入库洪峰流量是多少？"
- "对今年10月1日的那场降雨进行洪水预报，告诉我流域的洪水预报结果"
- "对7月2日0点至7月3日14点的降雨进行洪水预报，告诉洪水预报结果"

**目标**：根据需求新建人工预报方案并计算，然后查询该方案洪水结果。

**步骤**：
步骤1.  **解析会话参数**
    -   **调用接口工具**：无
    -   **输入**：用户会话
    -   **输出**：输出1：预报对象。如果请求全流域洪水预报结果，则输出全流域，如果请求指定水库水文站点蓄滞洪区预报结果，输出其中文名称；
		  输出2：降雨大概起止时间，根据历史某场降雨的大概时间描述信息，前后增加几天余量，得到一个能"包住"的降雨大概起止时间；
		  输出3：预报起止时间。如果未指明任何时间或指明时间为未来，则预报开始时间为当前整点时间，预报结束时间为开始时间+3天，此情况下本步骤结束后调到步骤4；
		  输出4：降雨条件描述。

步骤2.  **获取历史面雨量过程**
    -   **调用接口工具**：调用“rain_control.py”中的forecast_rain_ecmwf_avg工具。
    -   **输入**：使用 **步骤1** 的输出结果2--降雨大概起止时间
    -   **输出**：该时间段内的全流域平均历史逐小时面雨量过程。

步骤3.  **获取具体降雨起止时间**
    -   **调用接口工具**：无
    -   **输入**：使用 **步骤2** 的输出结果
    -   **输出**：预报起止时间，通过分析输入的逐小时降雨过程数据，获取本场降雨的具体开始和结束时间，注意掐头去尾，去掉主要降雨时段前后零星的少量降雨，预报开始时间为本场降雨开始时间，预报结束时间为本场降雨结束时间+3天。

步骤4.  **新建人工预报方案**
    -   **调用接口工具**：调用“modelplan_control.py”中的model_plan_add工具
    -   **输入**：使用**步骤1**的输出结果3或**步骤3**的输出结果的预报起止时间作为接口参数里的startTime和endTime参数；方案名称planName和方案描述planDesc参数根据预报时间情景生成，名称要简练；businessCode="flood_forecast_wg",businessName="卫共流域洪水预报应用模型";
    -   **输出**：JSON对象: {"success": true,"code": "200","message": "请求成功","data": 方案ID}

步骤5.  **解析指定降雨过程**
    -   **调用接口工具**：调用“rain_control.py”中的model_rain_pattern_detail工具
    -   **输入**：**步骤1** 的输出4--降雨条件描述
    -   **输出**：逐小时降雨过程。对输入的降雨条件描述进行解析，如果提及预报降雨总量，则将降雨总量以本步接口工具得到的雨型分解到逐小时；如果未提及指定降雨总量，则输出为null。

步骤6.  **预报方案降雨设置**
    -   **调用接口工具**：调用“rain_control.py”中的model_rain_area_add_ecmwf工具或model_rain_area_add_manual工具。当**步骤5** 的输出为null时，调用model_rain_area_add_ecmwf工具，否则调用model_rain_area_add_manual工具
    -   **输入**：**步骤4** 的输出--方案ID(用于2种工具)、**步骤5** 的输出--逐小时降雨过程(用于model_rain_area_add_manual工具)。
    -   **输出**：JSON对象: {"success": true,"code": "200","message": "请求成功","data": null}

步骤7.  **预报方案边界条件设置**
    -   **调用接口工具**：调用“hydromodel_set.py”中的change_boundry工具
    -   **输入**：参数1：plan_code采用**步骤4** 的输出方案ID、参数2: bnd_type="rf_model"。
    -   **输出**：JSON对象: {"success": true}

步骤8.  **计算该人工预报方案**
    -   **调用接口工具**：调用“modelplan_control.py”中的model_plan_calc工具
    -   **输入**：接口工具的固定参数
    -   **输出**：JSON对象: {"success": true}

步骤9.  **获取模型计算所需时间**
    -   **调用接口工具**：调用“modelplan_control.py”中的model_plan_detail工具
    -   **输入**：方案编码，采用**步骤4** 的输出方案ID
    -   **输出**：解析接口返回数据里的"expectSeconds"字段，获取计算所需时间(s)

步骤10.  **监视人工预报方案计算状态**
    -   **调用接口工具**：每5秒调用一次“modelplan_control.py”中的model_plan_detail工具
    -   **输入**：方案编码，采用**步骤4** 的输出方案ID
    -   **输出**：解析接口返回数据里的"state"字段，当"state"字段值为"已完成"时，进行步骤11；如果请求次数超过N次后，当"state"字段值还是为"待计算"或"计算错误"时，直接结束该流程，N=步骤9的"expectSeconds"字段值/5 + 10

步骤11.  **获取该人工预报方案结果**
    -   **调用接口工具**：调用“hydromodel_resultget.py”中的get_tjdata_result工具
    -   **输入**：方案ID字符串参数固定采用"model_auto"
    -   **输出**：JSON格式的自动预报方案结果，包含水库、河道断面、蓄滞洪区洪水结果。

步骤12.  **结果信息提取整理**
    -   **调用接口工具**：无
    -   **输入**：使用 **步骤4** 的输出结果、使用 **步骤1** 的输出结果
    -   **输出**：提取全流域或单一目标主要预报结果数据，包括结果概括描述和结果数据

步骤13.  **采用合适的Web页面模板进行结果输出**
    -   **调用接口工具**：无
    -   **调用Web页面模板**：全流域预报结果采用web模板1，单目标预报结果采用web模板2
    -   **输入**：使用 **步骤5** 的输出结果
    -   **输出**：Web页面
---
