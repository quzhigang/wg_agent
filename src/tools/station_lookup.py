"""
站点编码查询工具
根据站点名称快速获取站点编码(stcd)，支持模糊匹配
数据来源：开发资料/知识库文档/3、监测站点/监测站点基础信息
"""

from typing import List, Optional
from .base import BaseTool, ToolCategory, ToolParameter, ToolResult
from .registry import register_tool

# 站点数据字典: {站点名称: (站点编码, 站点类型)}
STATION_DATA = {
    # ========== 河道水文站 ==========
    "汲县": ("31003600", "河道水文站"),
    "秦庄": ("31003610", "河道水文站"),
    "淇门": ("31003700", "河道水文站"),
    "狐仙庙": ("31003714", "河道水文站"),
    "五陵": ("31003910", "河道水文站"),
    "元村": ("31004300", "河道水文站"),
    "修武": ("31004900", "河道水文站"),
    "占城": ("31005120", "河道水文站"),
    "南云门": ("31005140", "河道水文站"),
    "新村": ("31005700", "河道水文站"),
    "合河(共)": ("31006200", "河道水文站"),
    "合河共": ("31006200", "河道水文站"),
    "东碑村": ("31006210", "河道水文站"),
    "黄土岗": ("31006302", "河道水文站"),
    "下马营": ("31006310", "河道水文站"),
    "皇甫": ("31006320", "河道水文站"),
    "刘庄": ("31006410", "河道水文站"),
    "横水": ("31006600", "河道水文站"),
    "安阳": ("31006900", "河道水文站"),
    "何营": ("41425700", "河道水文站"),

    # ========== 水库水文站 ==========
    "盘石头": ("31005650", "水库水文站"),
    "盘石头水库": ("31005650", "水库水文站"),
    "小南海水库": ("31006700", "水库水文站"),
    "小南海": ("31006700", "水库水文站"),
    "城北水库": ("310K0025", "水库水文站"),
    "英雄水库": ("310K0033", "水库水文站"),
    "马池坡水库": ("310K0038", "水库水文站"),
    "东岗南坡水库": ("310K0030", "水库水文站"),
    "大峪水库": ("310K0044", "水库水文站"),
    "官庄北水库": ("310K0022", "水库水文站"),
    "东张水库": ("310K0029", "水库水文站"),
    "元家口水库": ("310K0028", "水库水文站"),
    "军营水库": ("310K0036", "水库水文站"),
    "团结水库": ("310K0051", "水库水文站"),
    "栗家洼水库": ("310K0031", "水库水文站"),
    "杨邑水库": ("310K0032", "水库水文站"),
    "川仓水库": ("310K0058", "水库水文站"),
    "四亩地水库": ("310K0017", "水库水文站"),
    "石峪沟水库": ("310K0065", "水库水文站"),

    # ========== 工程安全监测 ==========
    "东柏涧水库": ("310K0001", "工程安全监测"),
    "何坟水库": ("310K0002", "工程安全监测"),
    "五里涧水库": ("310K0003", "工程安全监测"),
    "小坟水库": ("310K0005", "工程安全监测"),
    "石门翁水库": ("310K0006", "工程安全监测"),
    "磊口水库": ("310K0007", "工程安全监测"),
    "众乐水库": ("310K0010", "工程安全监测"),
    "张北河水库": ("310K0013", "工程安全监测"),
    "龙泉水库": ("310K0014", "工程安全监测"),
    "西龙山水库": ("310K0016", "工程安全监测"),
    "温家沟水库": ("310K0023", "工程安全监测"),
    "马家山水库": ("310K0026", "工程安全监测"),
    "横水南坡水库": ("310K0041", "工程安全监测"),
    "北采桑水库": ("310K0043", "工程安全监测"),
    "中张贾水库": ("310K0045", "工程安全监测"),
    "罗圈水库": ("310K0046", "工程安全监测"),
    "沙蒋水库": ("310K0049", "工程安全监测"),
    "楼罗掌水库": ("310K0059", "工程安全监测"),
    "冯窑水库": ("310K0060", "工程安全监测"),
    "拍石头水库": ("310K0061", "工程安全监测"),
    "石桥水库": ("310K0075", "工程安全监测"),
    "夏庄水库": ("310K0076", "工程安全监测"),
    "白龙庙水库": ("310K0077", "工程安全监测"),
    "马村水库": ("310K0079", "工程安全监测"),
    "红卫水库": ("310K0081", "工程安全监测"),
    "柳林水库": ("310K0082", "工程安全监测"),

    # ========== 墒情站 ==========
    "道口(Ⅱ)": ("310A3800", "墒情站"),
    "朝歌(Ⅱ)": ("310A2400", "墒情站"),
    "黄洞": ("310A2401", "墒情站"),
    "庙口": ("310A2405", "墒情站"),
    "阳邵": ("311A3451", "墒情站"),
    "东姚(Ⅱ)": ("310A7601", "墒情站"),
    "天桥断(Ⅱ)": ("310A7600", "墒情站"),
    "原康": ("310A7603", "墒情站"),
    "合河共(Ⅱ)": ("310A6200", "墒情站"),
    "郎公庙": ("310A6204", "墒情站"),
    "古固寨": ("310A6205", "墒情站"),
    "小董": ("414A5704", "墒情站"),
    "谢旗营": ("414A5703", "墒情站"),
    "何营(Ⅱ)": ("414A5700", "墒情站"),
    "元村集": ("3.1004301e7", "墒情站"),
    "宝泉(Ⅱ)": ("310A5110", "墒情站"),
    "辉县": ("310A5111", "墒情站"),
    "南寨": ("310A5112", "墒情站"),
    "博爱(Ⅱ)": ("310A0200", "墒情站"),
    "阳庙": ("310A0202", "墒情站"),
    "界沟": ("310A0205", "墒情站"),
    "铜冶": ("310A6703", "墒情站"),
    "小南海(Ⅱ)": ("310A6700", "墒情站"),
    "吕村": ("310A6705", "墒情站"),
    "辛丰": ("3.1021041e7", "墒情站"),
    "张唐马": ("3.102104e7", "墒情站"),
    "申屯": ("310A5702", "墒情站"),
    "新村(Ⅱ)": ("310A5700", "墒情站"),
    "钮庄": ("310A5704", "墒情站"),
    "施屯": ("4.1402703e7", "墒情站"),
    "辛丰(Ⅱ)": ("310A1040", "墒情站"),
    "照镜": ("310A1041", "墒情站"),
    "冯庄": ("310A1045", "墒情站"),
    "沁阳(Ⅱ)": ("414A4901", "墒情站"),
    "石包头": ("310A3601", "墒情站"),
    "汲县(Ⅱ)": ("310A3600", "墒情站"),
    "顿坊店": ("310A3603", "墒情站"),
    "西村": ("310A4902", "墒情站"),
    "马鞍石": ("310A4903", "墒情站"),
    "修武(Ⅱ)": ("310A4900", "墒情站"),

    # ========== 闸站监测 ==========
    "郭盆闸": ("HP0074105220008064", "闸站监测"),
    "大李庄闸": ("HP0074106220000027", "闸站监测"),
    "胡庄闸": ("HP0074106210000414", "闸站监测"),
    "神标闸": ("HP0074105270000389", "闸站监测"),
    "豆公南闸": ("HP0074105270000298", "闸站监测"),
    "合河闸": ("HP0074107210000029", "闸站监测"),
    "马厂闸": ("HP007410724000022X", "闸站监测"),
    "修武洼村闸": ("HP0074108210000054", "闸站监测"),
    "位庄闸": ("SZ20", "闸站监测"),
    "凤泉湖节制闸": ("SZ23", "闸站监测"),
    "小河口节制闸": ("SZ24", "闸站监测"),
    "盐土庄节制闸": ("SZ27", "闸站监测"),
    "豆公北闸": ("HP0074105270000283", "闸站监测"),
    "硝河城关闸": ("SZ32", "闸站监测"),
    "四伏厂节制闸": ("SZ33", "闸站监测"),
    "东湖闸": ("SZ36", "闸站监测"),
    "西湖闸": ("SZ37", "闸站监测"),
    "双石桥节制闸": ("SZ39", "闸站监测"),
    "长丰沟节制闸": ("SZ41", "闸站监测"),
    "长虹渠分洪闸": ("SZ43", "闸站监测"),
    "白寺坡分洪闸": ("SZ44", "闸站监测"),
    "城关闸": ("HP0074108210000312", "闸站监测"),
    "常桥闸": ("HP0074108210000069", "闸站监测"),
    "朱营闸": ("HP0074108210000088", "闸站监测"),
    "于曹闸": ("HP0074105030000023", "闸站监测"),
    "赵王沟退水闸": ("HP0074105230000154", "闸站监测"),
    "长虹渠退水闸": ("HP0074105260000666", "闸站监测"),
    "八里沟退水闸": ("HP0074105230000211", "闸站监测"),
    "白寺坡退水闸": ("HP0074106210000050", "闸站监测"),
    "民丰沟下口闸": ("HP0074106210000137", "闸站监测"),
    "田大晁退水闸": ("HP0074105270000412", "闸站监测"),
    "硝河退水闸": ("HP0074109220000261", "闸站监测"),
    "北长虹渠退水闸": ("SZ25", "闸站监测"),
    "南长虹渠退水闸": ("SZ26", "闸站监测"),
    "长丰沟退水闸": ("SZ28", "闸站监测"),
    "民丰沟上口闸": ("SZ29", "闸站监测"),
    "浚内沟退水闸": ("SZ30", "闸站监测"),
    "王家口退水闸": ("SZ34", "闸站监测"),
    "梨园沟退水闸": ("SZ35", "闸站监测"),
    "故城沟退水闸": ("SZ38", "闸站监测"),
    "苏村沟退水闸": ("SZ40", "闸站监测"),
    "红卫沟退水闸": ("SZ42", "闸站监测"),
    "镜高涝河闸": ("SZ22", "闸站监测"),
    "大狮涝河闸": ("SZ21", "闸站监测"),

    # ========== AI监测站点 ==========
    "大沙河断面3": ("ST_AI90", "AI监测站点"),
    "卫河断面5": ("ST_AI69", "AI监测站点"),
    "共产主义渠上段断面": ("ST_AI70", "AI监测站点"),
    "卫河断面8": ("ST_AI64", "AI监测站点"),
    "大沙河断面7": ("ST_AI95", "AI监测站点"),
    "南水北调交叉断面1": ("ST_AI81", "AI监测站点"),
    "汲城一村断面": ("ST_AI62", "AI监测站点"),
    "卫河断面9": ("ST_AI61", "AI监测站点"),
    "卫河断面10": ("ST_AI36", "AI监测站点"),
    "长虹渠断面1": ("ST_AI40", "AI监测站点"),
    "共产主义渠断面3": ("ST_AI38", "AI监测站点"),
    "卫河断面2": ("ST_AI39", "AI监测站点"),
    "百泉河断面1": ("ST_AI66", "AI监测站点"),
    "卫河共产主义渠交叉断面1": ("ST_AI29", "AI监测站点"),
    "共产主义渠卫河交叉断面2": ("ST_AI68", "AI监测站点"),
    "长虹渠断面2": ("ST_AI54", "AI监测站点"),
    "共产主义渠断面1": ("ST_AI41", "AI监测站点"),
    "共渠十里河断面": ("ST_AI100", "AI监测站点"),
    "圈里村断面": ("ST_AI32", "AI监测站点"),
    "北长虹渠断面": ("ST_AI55", "AI监测站点"),
    "南长虹渠断面": ("ST_AI56", "AI监测站点"),
    "十里河断面": ("ST_AI57", "AI监测站点"),
    "民丰排水沟卫河交叉断面": ("ST_AI33", "AI监测站点"),
    "共产主义渠断面5": ("ST_AI46", "AI监测站点"),
    "卫河断面1": ("ST_AI47", "AI监测站点"),
    "共产主义渠断面4": ("ST_AI35", "AI监测站点"),
    "山门河断面2": ("ST_AI97", "AI监测站点"),
    "安阳河豆公闸断面": ("ST_AI103", "AI监测站点"),
    "大沙河断面5": ("ST_AI77", "AI监测站点"),
    "汤河断面": ("ST_AI22", "AI监测站点"),
    "汤永河断面2": ("ST_AI25", "AI监测站点"),
    "大沙河断面1": ("ST_AI94", "AI监测站点"),
    "大狮涝河断面": ("ST_AI76", "AI监测站点"),
    "大沙河断面4": ("ST_AI78", "AI监测站点"),
    "大沙河断面6": ("ST_AI75", "AI监测站点"),
    "西寺庄村断面": ("ST_AI73", "AI监测站点"),
    "峪河断面1": ("ST_AI72", "AI监测站点"),
    "峪河断面2": ("ST_AI80", "AI监测站点"),
    "安阳河断面3": ("ST_AI13", "AI监测站点"),
    "卫河断面4": ("ST_AI60", "AI监测站点"),
    "大沙河断面10": ("ST_AI71", "AI监测站点"),
    "石门河断面2": ("ST_AI82", "AI监测站点"),
    "安阳河断面5": ("ST_AI21", "AI监测站点"),
    "大南洞村断面": ("ST_AI3", "AI监测站点"),
    "粉红江断面": ("ST_AI20", "AI监测站点"),
    "共产主义渠断面2": ("ST_AI48", "AI监测站点"),
    "共产主义渠断面6": ("ST_AI49", "AI监测站点"),
    "洪河断面": ("ST_AI18", "AI监测站点"),
    "石门河断面1": ("ST_AI67", "AI监测站点"),
    "思德河断面1": ("ST_AI43", "AI监测站点"),
    "汤永河断面1": ("ST_AI6", "AI监测站点"),
    "卫河断面11": ("ST_AI7", "AI监测站点"),
    "卫河断面12": ("ST_AI5", "AI监测站点"),
    "卫河断面3": ("ST_AI30", "AI监测站点"),
    "梨园沟安阳河交叉断面": ("ST_AI14", "AI监测站点"),
    "安阳河断面6": ("ST_AI19", "AI监测站点"),
    "百泉河断面2": ("ST_AI84", "AI监测站点"),
    "大沙河断面2": ("ST_AI86", "AI监测站点"),
    "大沙河断面9": ("ST_AI87", "AI监测站点"),
    "共产主义渠断面7": ("ST_AI63", "AI监测站点"),
    "纸坊沟河断面2": ("ST_AI79", "AI监测站点"),
    "大沙河断面8": ("ST_AI96", "AI监测站点"),
    "香泉河断面": ("ST_AI45", "AI监测站点"),
    "长丰沟断面": ("ST_AI34", "AI监测站点"),
    "东孟姜女河断面": ("ST_AI59", "AI监测站点"),
    "沧河断面": ("ST_AI44", "AI监测站点"),
    "浚内沟断面2": ("ST_AI98", "AI监测站点"),
    "共渠香泉河断面": ("ST_AI99", "AI监测站点"),
    "纸坊沟河断面1": ("ST_AI74", "AI监测站点"),
    "山门河断面1": ("ST_AI88", "AI监测站点"),
    "安阳河断面7": ("ST_AI12", "AI监测站点"),
    "茶店坡沟断面1": ("ST_AI11", "AI监测站点"),
    "茶店坡沟断面2": ("ST_AI10", "AI监测站点"),
    "八里沟断面": ("ST_AI8", "AI监测站点"),
    "烈杠营村断面": ("ST_AI85", "AI监测站点"),
    "南水北调交叉断面3": ("ST_AI83", "AI监测站点"),
    "思德河断面2": ("ST_AI28", "AI监测站点"),
    "王贵庄村断面": ("ST_AI9", "AI监测站点"),
    "幸福河大沙河断面": ("ST_AI93", "AI监测站点"),
    "安阳河断面1": ("ST_AI17", "AI监测站点"),
    "安阳河断面2": ("ST_AI15", "AI监测站点"),
    "安阳河断面4": ("ST_AI4", "AI监测站点"),
    "浚内沟断面1": ("ST_AI31", "AI监测站点"),
    "梨园沟断面": ("ST_AI16", "AI监测站点"),
    "民丰排水沟断面2": ("ST_AI37", "AI监测站点"),
    "淇河断面1": ("ST_AI50", "AI监测站点"),
    "淇河断面2": ("ST_AI51", "AI监测站点"),
    "淇河断面4": ("ST_AI42", "AI监测站点"),
    "淇门东街断面": ("ST_AI53", "AI监测站点"),
    "卫河故道断面": ("ST_AI58", "AI监测站点"),
    "西孟姜女河断面": ("ST_AI65", "AI监测站点"),
    "小河口村断面": ("ST_AI52", "AI监测站点"),
    "冯家港村": ("ST_AI101", "AI监测站点"),
    "良相村": ("ST_AI102", "AI监测站点"),
    "蒋沟河断面": ("ST_AI91", "AI监测站点"),
    "南水北调交叉断面2": ("ST_AI23", "AI监测站点"),
    "淇河断面3": ("ST_AI27", "AI监测站点"),
    "淇河断面5": ("ST_AI26", "AI监测站点"),
    "新河大沙河交叉断面": ("ST_AI89", "AI监测站点"),
    "新河断面": ("ST_AI92", "AI监测站点"),
    "赵王沟断面": ("ST_AI24", "AI监测站点"),
    "卫河断面7": ("ST_AI1", "AI监测站点"),
    "硝河断面": ("ST_AI2", "AI监测站点"),

    # ========== 雨量站(部分) ==========
    "双头泉": ("31023135", "雨量站"),
    "福头": ("31023138", "雨量站"),
    "红豆峡": ("31023143", "雨量站"),
    "双底": ("31007880", "雨量站"),
    "锡崖沟": ("31020720", "雨量站"),
    "苏家井": ("31020748", "雨量站"),
    "凤凰": ("31020760", "雨量站"),
    "灵岩寺": ("31020770", "雨量站"),
    "东上河": ("31020680", "雨量站"),
    "小磨河": ("31007868", "雨量站"),
    "沙场": ("31022610", "雨量站"),
    "李家河": ("31023110", "雨量站"),
    "高家": ("31022620", "雨量站"),
    "宝泉": ("31005110", "雨量站"),
    "花木": ("31005130", "雨量站"),
    "石门水库": ("31005200", "雨量站"),
    "饮马口": ("31005460", "雨量站"),
    "新乡水利局": ("31005461", "雨量站"),
    "新乡水文局": ("31005462", "雨量站"),
    "孟营": ("31005463", "雨量站"),
    "豫北局": ("31005464", "雨量站"),
    "市政府": ("31005465", "雨量站"),
    "凤泉区政府": ("31005466", "雨量站"),
    "东鲁堡": ("31005467", "雨量站"),
    "分将池": ("31005468", "雨量站"),
    "前郭柳": ("31005469", "雨量站"),
    "正面": ("31005485", "雨量站"),
    "塔岗": ("31005500", "雨量站"),
    "西南庄": ("31005510", "雨量站"),
    "夺丰": ("31005530", "雨量站"),
    "红卫": ("31005540", "雨量站"),
    "陈家院": ("31005550", "雨量站"),
    "高村": ("31005560", "雨量站"),
    "三交口": ("31005580", "雨量站"),
    "石大沟": ("31005651", "雨量站"),
    "弓上": ("31006000", "雨量站"),
    "石门": ("31006050", "雨量站"),
    "联庄": ("31006060", "雨量站"),
    "河口": ("31006070", "雨量站"),
}


class StationLookupTool(BaseTool):
    """
    站点编码查询工具
    根据站点名称快速获取站点编码(stcd)，支持精确匹配和模糊匹配
    """

    @property
    def name(self) -> str:
        return "lookup_station_code"

    @property
    def description(self) -> str:
        return "根据站点名称查询站点编码(stcd)，支持精确匹配和模糊匹配，可用于水雨情实时数据查询前获取站点编码"

    @property
    def category(self) -> ToolCategory:
        return ToolCategory.BASIN_INFO

    @property
    def parameters(self) -> List[ToolParameter]:
        return [
            ToolParameter(
                name="station_name",
                type="string",
                description="站点名称，支持模糊匹配（如输入'淇门'可匹配'淇门'、'淇门东街断面'等）",
                required=True
            ),
            ToolParameter(
                name="station_type",
                type="string",
                description="站点类型过滤（可选）：河道水文站、水库水文站、工程安全监测、墒情站、闸站监测、AI监测站点、雨量站",
                required=False
            ),
            ToolParameter(
                name="exact_match",
                type="boolean",
                description="是否精确匹配，默认False（模糊匹配）",
                required=False,
                default=False
            )
        ]

    async def execute(self, **kwargs) -> ToolResult:
        station_name = kwargs.get('station_name', '').strip()
        station_type = kwargs.get('station_type')
        exact_match = kwargs.get('exact_match', False)

        if not station_name:
            return ToolResult(success=False, error="站点名称不能为空")

        results = []

        for name, (code, stype) in STATION_DATA.items():
            # 类型过滤
            if station_type and stype != station_type:
                continue

            # 匹配逻辑
            if exact_match:
                if name == station_name:
                    results.append({"stnm": name, "stcd": code, "type": stype})
            else:
                if station_name in name or name in station_name:
                    results.append({"stnm": name, "stcd": code, "type": stype})

        if not results:
            return ToolResult(
                success=True,
                data={"message": f"未找到匹配'{station_name}'的站点", "stcd": None, "stnm": None},
                metadata={"query": station_name, "count": 0}
            )

        # 返回结构：stcd/stnm直接可用，stations包含完整列表
        return ToolResult(
            success=True,
            data={
                "stcd": results[0]["stcd"],  # 第一个匹配的站点编码，方便直接引用
                "stnm": results[0]["stnm"],  # 第一个匹配的站点名称
                "stations": results          # 完整匹配列表
            },
            metadata={"query": station_name, "count": len(results)}
        )


# 注册工具
register_tool(StationLookupTool())
