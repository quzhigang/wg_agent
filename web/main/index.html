<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´åº“æ´ªæ°´é¢„æŠ¥ç»“æœå±•ç¤º</title>
    <link rel="stylesheet" href="css/style.css?v=1.9">
    <link rel="icon" href="data:;base64,=">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="layout-grid">
        <div class="iframe-container">
            <iframe id="mainContentFrame" src="res_module/index.html" frameborder="0"></iframe>
        </div>
        <div class="resizer resizer-h" id="resizer-sidebar"></div>
        <aside class="left-sidebar">
            <div class="main-display-area panel-style">
                <div class="avatar-box">
                    <div class="avatar-content">
                        <img src="img/szr_no_bg.png" alt="AIæ•°å­—äºº" class="avatar-image">
                    </div>
                </div>
                <div class="process-box">
                    <div class="process-content">
                        <ul class="log-list" id="logList">
                            <li class="message-item message-system"><span class="message-text">> ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ...</span></li>
                            <li class="message-item message-system"><span class="message-text">> ç­‰å¾…æ‚¨çš„æé—®...</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="chat-input-box panel-style">
                <div class="toolbar">
                    <button id="newChatBtn" class="toolbar-btn" title="æ–°å¯¹è¯">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    </button>
                    <button id="historyBtn" class="toolbar-btn" title="å†å²å¯¹è¯">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                    </button>
                </div>
                <div class="chat-input-wrapper">
                    <textarea id="chatInput" class="chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                    <button id="chatSendBtn" class="chat-send-btn">å‘é€</button>
                </div>
            </div>
        </aside>
    </div>

    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-dialog">
            <div class="confirm-content"><p id="confirmMessage"></p></div>
            <div class="confirm-buttons">
                <button id="confirmCancel" class="confirm-btn cancel-btn">å–æ¶ˆ</button>
                <button id="confirmOk" class="confirm-btn ok-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="confirm-modal">
        <div class="confirm-dialog">
            <div class="confirm-content"><p id="alertMessage"></p></div>
            <div class="confirm-buttons">
                <button id="alertOk" class="confirm-btn ok-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="history-modal">
        <div class="history-header"><span>å†å²å¯¹è¯</span><span id="closeHistory" class="history-close">&times;</span></div>
        <ul id="historyListContainer" class="history-list"></ul>
    </div>

    <script src="js/resizer.js"></script>
    <script>
        (function() {
            let currentConversationId = null;

            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const logList = document.getElementById('logList');
            const mainContentFrame = document.getElementById('mainContentFrame');
            const historyModal = document.getElementById('historyModal');
            const historyListContainer = document.getElementById('historyListContainer');

            window.toggleProcess = function(header) {
                const container = header.closest('.execution-process');
                if (container) container.classList.toggle('collapsed');
            };

            function renderMarkdown(text) {
                if (window.marked && window.marked.parse) {
                    const renderer = new marked.Renderer();
                    renderer.link = function(token) {
                        var href = token.href || '';
                        var linkText = token.text || href;
                        return '<a href="' + href + '" target="_blank" rel="noopener">' + linkText + '</a>';
                    };
                    return window.marked.parse(text, { renderer: renderer });
                }
                return text.split(String.fromCharCode(10)).join('<br>');
            }

            function scrollToBottom() {
                setTimeout(() => {
                    const box = document.querySelector('.process-box');
                    if (box) box.scrollTop = box.scrollHeight;
                }, 50);
            }

            window.addLog = function(text, type = 'system') {
                const li = document.createElement('li');
                li.className = 'message-item message-' + type;
                if (type === 'user') {
                    li.innerHTML = '<div class="message-content"><div class="message-icon user-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="message-bubble">' + text + '</div></div>';
                } else if (type === 'assistant') {
                    li.innerHTML = '<div class="message-content"><img src="img/xw.png" class="message-icon assistant-icon-img"><div class="message-bubble markdown-content">' + renderMarkdown(text) + '</div></div>';
                } else {
                    li.innerHTML = '<span class="message-text">' + text + '</span>';
                }
                logList.appendChild(li);
                scrollToBottom();
                return li;
            };

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                addLog(message, 'user');
                chatInput.value = '';

                const assistantLi = document.createElement('li');
                assistantLi.className = 'message-item message-assistant';
                assistantLi.innerHTML = `
                    <div class="message-content" style="width: 100%;">
                        <img src="img/xw.png" alt="å°å«" class="message-icon assistant-icon-img">
                        <div class="message-bubble" style="flex: 1; max-width: none;">
                            <div class="execution-process" style="width: 100%;">
                                <div class="process-header" onclick="toggleProcess(this)">
                                    <span class="toggle-icon">â–¼</span><span>æ™ºèƒ½ä½“æ‰§è¡Œè¿‡ç¨‹</span>
                                </div>
                                <div class="process-body">
                                    <div class="intent-status process-item">
                                        <span class="process-icon">â³</span><span>æ­£åœ¨åˆ†ææ„å›¾...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="final-answer markdown-content">
                                <div class="typing-dots"><span></span><span></span><span></span></div>
                            </div>
                        </div>
                    </div>`;
                logList.appendChild(assistantLi);
                scrollToBottom();

                const uiElements = {
                    assistantLi,
                    processBody: assistantLi.querySelector('.process-body'),
                    finalAnswer: assistantLi.querySelector('.final-answer'),
                    executionProcess: assistantLi.querySelector('.execution-process'),
                    processHeaderSpan: assistantLi.querySelector('.process-header span:last-child')
                };

                try {
                    const response = await fetch('/chat/stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message, user_id: 'user123', conversation_id: currentConversationId })
                    });

                    if (!response.ok) throw new Error('HTTP ' + response.status);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split(String.fromCharCode(10));
                        buffer = lines.pop();

                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line.startsWith('data:')) continue;
                            const jsonStr = line.substring(5).trim();
                            try {
                                const data = JSON.parse(jsonStr);
                                handleEvent(data, uiElements);
                            } catch (e) {}
                        }
                    }
                } catch (err) {
                    uiElements.finalAnswer.innerHTML = '<div style="color:#ff4d4f">è¿æ¥å¼‚å¸¸: ' + err.message + '</div>';
                }
            }

            function handleEvent(data, ui) {
                switch (data.type) {
                    case 'start': currentConversationId = data.conversation_id; break;
                    case 'intent':
                        const intentEl = ui.assistantLi.querySelector('.intent-status');
                        if (intentEl) {
                            intentEl.innerHTML = '<span class="process-icon">âœ“</span><span>ç¡®è®¤æ„å›¾: ' + (data.intent || 'æœªçŸ¥') + ' (' + Math.round((data.confidence || 0) * 100) + '%)</span>';
                        }
                        break;
                    case 'rag':
                        // åªæœ‰æ£€ç´¢åˆ°çŸ¥è¯†æ—¶æ‰æ˜¾ç¤º
                        if (data.doc_count && data.doc_count > 0) {
                            const ragDiv = document.createElement('div');
                            ragDiv.className = 'process-item';
                            ragDiv.innerHTML = '<span class="process-icon">ğŸ“š</span><span>æ£€ç´¢åˆ° ' + data.doc_count + ' æ¡ç›¸å…³çŸ¥è¯†</span>';
                            ui.processBody.appendChild(ragDiv);
                        }
                        break;
                    case 'plan':
                        const planDiv = document.createElement('div');
                        planDiv.className = 'process-item';
                        planDiv.innerHTML = '<div style="width:100%"><div style="margin-bottom:5px;color:#666">æ‰§è¡Œè®¡åˆ’:</div><div class="steps-container" style="padding-left:10px"></div></div>';
                        ui.processBody.appendChild(planDiv);
                        const container = planDiv.querySelector('.steps-container');
                        (data.steps || []).forEach(s => {
                            const sEl = document.createElement('div');
                            sEl.className = 'step-item';
                            sEl.setAttribute('data-id', s.step_id);
                            sEl.innerHTML = '<span>æ­¥éª¤' + s.step_id + 'ï¼š' + s.description + '</span><span class="step-status"></span>';
                            container.appendChild(sEl);
                        });
                        break;
                    case 'step_start':
                        const startEl = ui.assistantLi.querySelector('.step-item[data-id="' + data.step_id + '"]');
                        if (startEl) {
                            startEl.classList.add('active');
                            startEl.querySelector('.step-status').innerHTML = '<div class="loading-spinner-small"></div>';
                        }
                        break;
                    case 'step_end':
                        const endEl = ui.assistantLi.querySelector('.step-item[data-id="' + data.step_id + '"]');
                        if (endEl) {
                            endEl.classList.remove('active');
                            endEl.classList.add('completed');
                            endEl.querySelector('.step-status').innerHTML = '<span style="color:#28a745">âœ“</span>';
                        }
                        break;
                    case 'content':
                        if (data.data) {
                            ui.finalAnswer.innerHTML = renderMarkdown(data.data);
                            if (data.page_url) mainContentFrame.src = data.page_url;
                        }
                        break;
                    case 'done':
                        if (ui.executionProcess) ui.executionProcess.classList.add('collapsed');
                        if (ui.processHeaderSpan) ui.processHeaderSpan.textContent = 'æ‰§è¡Œè¿‡ç¨‹ (å·²å®Œæˆ)';
                        scrollToBottom();
                        break;
                    case 'error':
                        ui.finalAnswer.innerHTML = '<div style="color:#ff4d4f">é”™è¯¯: ' + (data.data || 'æœªçŸ¥é”™è¯¯') + '</div>';
                        break;
                }
            }

            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });

            document.getElementById('newChatBtn').addEventListener('click', () => {
                currentConversationId = null;
                logList.innerHTML = '<li class="message-item message-system"><span class="message-text">> å¼€å¯æ–°å¯¹è¯...</span></li>';
                mainContentFrame.src = 'res_module/index.html';
            });

            document.getElementById('historyBtn').addEventListener('click', async () => {
                try {
                    const res = await fetch('/chat/conversations?user_id=user123');
                    const result = await res.json();
                    if (result.success) {
                        historyListContainer.innerHTML = '';
                        (result.data || []).forEach(conv => {
                            const li = document.createElement('li');
                            li.className = 'history-item';
                            li.innerHTML = '<input type="checkbox" class="history-checkbox" data-id="' + conv.id + '"><span class="history-title">' + (conv.title || conv.id) + '</span>';
                            li.querySelector('.history-title').addEventListener('click', () => loadConversation(conv.id));
                            historyListContainer.appendChild(li);
                        });
                        historyModal.style.display = 'flex';
                    }
                } catch (e) {}
            });

            document.getElementById('closeHistory').addEventListener('click', () => { historyModal.style.display = 'none'; });

            async function loadConversation(id) {
                currentConversationId = id;
                historyModal.style.display = 'none';
                logList.innerHTML = '<li class="message-item message-system"><span class="message-text">> æ­£åœ¨åŠ è½½å†å²å¯¹è¯...</span></li>';
                try {
                    const res = await fetch('/chat/conversations/' + id + '/messages');
                    const result = await res.json();
                    if (result.success) {
                        logList.innerHTML = '';
                        result.data.forEach(m => addLog(m.content, m.role === 'user' ? 'user' : 'assistant'));
                    }
                } catch (e) { addLog('> é”™è¯¯: æ— æ³•åŠ è½½å†å²æ¶ˆæ¯'); }
            }
        })();
    </script>
</body>
</html>
