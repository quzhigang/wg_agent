<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´åº“æ´ªæ°´é¢„æŠ¥ç»“æœå±•ç¤º</title>
    <link rel="stylesheet" href="css/style.css?v=2.0">
    <link rel="icon" href="data:;base64,=">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="layout-grid">
        <div class="iframe-container">
            <iframe id="mainContentFrame" src="res_module/index.html" frameborder="0"></iframe>
        </div>
        <div class="resizer resizer-h" id="resizer-sidebar"></div>
        <aside class="left-sidebar">
            <div class="main-display-area panel-style">
                <div class="avatar-box">
                    <div class="avatar-content">
                        <img src="img/szr_no_bg.png" alt="AIæ•°å­—äºº" class="avatar-image">
                    </div>
                </div>
                <div class="process-box">
                    <div class="process-content">
                        <ul class="log-list" id="logList">
                            <li class="message-item message-system"><span class="message-text">> ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ...</span></li>
                            <li class="message-item message-system"><span class="message-text">> ç­‰å¾…æ‚¨çš„æé—®...</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="chat-input-box panel-style">
                <div class="toolbar">
                    <button id="newChatBtn" class="toolbar-btn" title="æ–°å¯¹è¯">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    </button>
                    <button id="historyBtn" class="toolbar-btn" title="å†å²å¯¹è¯">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                    </button>
                    <button id="architectureBtn" class="toolbar-btn" title="ç³»ç»Ÿæ¶æ„å›¾" style="margin-left: auto;">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M22 11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3h7zM7 9H4V5h3v4zm10 6h3v4h-3v-4zm0-10h3v4h-3V5z"/></svg>
                    </button>
                </div>
                <div class="chat-input-wrapper">
                    <textarea id="chatInput" class="chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                    <button id="chatSendBtn" class="chat-send-btn">å‘é€</button>
                </div>
            </div>
        </aside>
    </div>

    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-dialog">
            <div class="confirm-content"><p id="confirmMessage"></p></div>
            <div class="confirm-buttons">
                <button id="confirmCancel" class="confirm-btn cancel-btn">å–æ¶ˆ</button>
                <button id="confirmOk" class="confirm-btn ok-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="confirm-modal">
        <div class="confirm-dialog">
            <div class="confirm-content"><p id="alertMessage"></p></div>
            <div class="confirm-buttons">
                <button id="alertOk" class="confirm-btn ok-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="history-modal">
        <div class="history-header"><span>å†å²å¯¹è¯</span><span id="closeHistory" class="history-close">&times;</span></div>
        <ul id="historyListContainer" class="history-list"></ul>
    </div>

    <script src="js/resizer.js"></script>
    <script>
        (function() {
            let currentConversationId = null;

            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const logList = document.getElementById('logList');
            const mainContentFrame = document.getElementById('mainContentFrame');
            const historyModal = document.getElementById('historyModal');
            const historyListContainer = document.getElementById('historyListContainer');

            window.toggleProcess = function(header) {
                const container = header.closest('.execution-process');
                if (container) container.classList.toggle('collapsed');
            };

            function renderMarkdown(text) {
                if (window.marked && window.marked.parse) {
                    const renderer = new marked.Renderer();
                    renderer.link = function(token) {
                        var href = token.href || '';
                        var linkText = token.text || href;
                        return '<a href="' + href + '" target="_blank" rel="noopener">' + linkText + '</a>';
                    };
                    return window.marked.parse(text, { renderer: renderer });
                }
                return text.split(String.fromCharCode(10)).join('<br>');
            }

            function scrollToBottom() {
                setTimeout(() => {
                    const box = document.querySelector('.process-box');
                    if (box) box.scrollTop = box.scrollHeight;
                }, 50);
            }

            window.addLog = function(text, type = 'system') {
                const li = document.createElement('li');
                li.className = 'message-item message-' + type;
                if (type === 'user') {
                    li.innerHTML = '<div class="message-content"><div class="message-icon user-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="message-bubble">' + text + '</div></div>';
                } else if (type === 'assistant') {
                    li.innerHTML = '<div class="message-content"><img src="img/xw.png" class="message-icon assistant-icon-img"><div class="message-bubble markdown-content">' + renderMarkdown(text) + '</div></div>';
                } else {
                    li.innerHTML = '<span class="message-text">' + text + '</span>';
                }
                logList.appendChild(li);
                scrollToBottom();
                return li;
            };

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                addLog(message, 'user');
                chatInput.value = '';

                const assistantLi = document.createElement('li');
                assistantLi.className = 'message-item message-assistant';
                assistantLi.innerHTML = `
                    <div class="message-content" style="width: 100%;">
                        <img src="img/xw.png" alt="å°å«" class="message-icon assistant-icon-img">
                        <div class="message-bubble" style="flex: 1; max-width: none;">
                            <div class="execution-process" style="width: 100%;">
                                <div class="process-header" onclick="toggleProcess(this)">
                                    <span class="toggle-icon">â–¼</span><span>æ™ºèƒ½ä½“æ‰§è¡Œè¿‡ç¨‹</span>
                                </div>
                                <div class="process-body">
                                    <div class="intent-status process-item">
                                        <span class="process-icon">â³</span><span>æ­£åœ¨åˆ†ææ„å›¾...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="final-answer markdown-content">
                                <div class="typing-dots"><span></span><span></span><span></span></div>
                            </div>
                        </div>
                    </div>`;
                logList.appendChild(assistantLi);
                scrollToBottom();

                const uiElements = {
                    assistantLi,
                    processBody: assistantLi.querySelector('.process-body'),
                    finalAnswer: assistantLi.querySelector('.final-answer'),
                    executionProcess: assistantLi.querySelector('.execution-process'),
                    processHeaderSpan: assistantLi.querySelector('.process-header span:last-child')
                };

                try {
                    const response = await fetch('/chat/stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message, user_id: 'user123', conversation_id: currentConversationId })
                    });

                    if (!response.ok) throw new Error('HTTP ' + response.status);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split(String.fromCharCode(10));
                        buffer = lines.pop();

                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line.startsWith('data:')) continue;
                            const jsonStr = line.substring(5).trim();
                            try {
                                const data = JSON.parse(jsonStr);
                                handleEvent(data, uiElements);
                            } catch (e) {}
                        }
                    }
                } catch (err) {
                    uiElements.finalAnswer.innerHTML = '<div style="color:#ff4d4f">è¿æ¥å¼‚å¸¸: ' + err.message + '</div>';
                }
            }

            function handleEvent(data, ui) {
                console.log('[DEBUG] Received event:', data.type, data);  // è°ƒè¯•æ—¥å¿—

                // æ„å›¾ç±»åˆ«ä¸­æ–‡æ˜ å°„
                const categoryMap = {
                    'chat': 'ä¸€èˆ¬å¯¹è¯',
                    'knowledge': 'çŸ¥è¯†æŸ¥è¯¢',
                    'business': 'ä¸šåŠ¡æ“ä½œ'
                };
                // ä¸šåŠ¡å­æ„å›¾ä¸­æ–‡æ˜ å°„
                const subIntentMap = {
                    'data_query': 'ç›‘æµ‹æ•°æ®æŸ¥è¯¢',
                    'flood_forecast': 'æ´ªæ°´é¢„æŠ¥',
                    'flood_simulation': 'æ´ªæ°´é¢„æ¼”',
                    'emergency_plan': 'é¢„æ¡ˆç”Ÿæˆ',
                    'damage_assessment': 'ç¾æŸè¯„ä¼°',
                    'other': 'å…¶ä»–ä¸šåŠ¡'
                };
                // å·¥ä½œæµIDåˆ°ä¸­æ–‡åç§°æ˜ å°„
                const workflowNameMap = {
                    'get_auto_forecast_result': 'æŸ¥è¯¢æœ€æ–°è‡ªåŠ¨é¢„æŠ¥ç»“æœ',
                    'get_history_autoforecast_result': 'æŸ¥è¯¢å†å²è‡ªåŠ¨é¢„æŠ¥ç»“æœ',
                    'flood_autoforecast_getresult': 'å¯åŠ¨è‡ªåŠ¨é¢„æŠ¥å¹¶è·å–ç»“æœ',
                    'get_manual_forecast_result': 'æŸ¥è¯¢äººå·¥é¢„æŠ¥ç»“æœ',
                    'flood_manualforecast_getresult': 'å¯åŠ¨äººå·¥é¢„æŠ¥å¹¶è·å–ç»“æœ'
                };

                switch (data.type) {
                    case 'start': currentConversationId = data.conversation_id; break;
                    case 'intent_stage':
                        // åˆ†é˜¶æ®µæ„å›¾è¯†åˆ«äº‹ä»¶
                        const stageEl = ui.assistantLi.querySelector('.intent-status');
                        if (stageEl) {
                            const stage = data.stage || 0;
                            const stageName = data.stage_name || '';

                            if (stageName === 'intent_category') {
                                // ç¬¬1é˜¶æ®µï¼šæ˜¾ç¤ºæ„å›¾ç±»åˆ«
                                const category = data.intent_category || '';
                                const categoryName = categoryMap[category] || category;
                                const confidence = Math.round((data.confidence || 0) * 100);

                                if (category === 'business') {
                                    // ä¸šåŠ¡ç±»ï¼šæ˜¾ç¤ºç±»åˆ«ï¼Œç­‰å¾…å­æ„å›¾
                                    stageEl.innerHTML = '<span class="process-icon" style="color:#1890ff">â³</span><span>æ„å›¾è¯†åˆ«: <span style="color:#1890ff;font-weight:500">' + categoryName + '</span> <span style="color:#999">(' + confidence + '%)</span> <span style="color:#999;font-size:12px">æ­£åœ¨åˆ†æå­æ„å›¾...</span></span>';
                                } else {
                                    // éä¸šåŠ¡ç±»ï¼šç›´æ¥å®Œæˆ
                                    stageEl.innerHTML = '<span class="process-icon" style="color:#52c41a">âœ“</span><span>æ„å›¾è¯†åˆ«: <span style="color:#1890ff;font-weight:500">' + categoryName + '</span> <span style="color:#999">(' + confidence + '%)</span></span>';
                                }
                            } else if (stageName === 'business_sub_intent') {
                                // ç¬¬2é˜¶æ®µï¼šè¿½åŠ ä¸šåŠ¡å­æ„å›¾
                                const subIntent = data.business_sub_intent || '';
                                const subIntentName = subIntentMap[subIntent] || subIntent;

                                // è·å–å½“å‰æ˜¾ç¤ºçš„ç±»åˆ«
                                const currentHtml = stageEl.innerHTML;
                                const confidenceMatch = currentHtml.match(/\((\d+)%\)/);
                                const confidence = confidenceMatch ? confidenceMatch[1] : '90';

                                stageEl.innerHTML = '<span class="process-icon" style="color:#1890ff">â³</span><span>æ„å›¾è¯†åˆ«: <span style="color:#1890ff;font-weight:500">ä¸šåŠ¡æ“ä½œ</span> > <span style="color:#52c41a;font-weight:500">' + subIntentName + '</span> <span style="color:#999">(' + confidence + '%)</span> <span style="color:#999;font-size:12px">æ­£åœ¨åŒ¹é…å·¥ä½œæµ...</span></span>';
                            } else if (stageName === 'workflow_match') {
                                // ç¬¬3é˜¶æ®µï¼šå·¥ä½œæµåŒ¹é…å®Œæˆ
                                const matchedWorkflow = data.matched_workflow || '';
                                const subIntent = data.business_sub_intent || '';
                                const subIntentName = subIntentMap[subIntent] || subIntent;

                                // è·å–å½“å‰æ˜¾ç¤ºçš„ç½®ä¿¡åº¦
                                const currentHtml = stageEl.innerHTML;
                                const confidenceMatch = currentHtml.match(/\((\d+)%\)/);
                                const confidence = confidenceMatch ? confidenceMatch[1] : '90';

                                // æ„å»ºæ„å›¾æ–‡æœ¬
                                let intentText = '<span style="color:#1890ff;font-weight:500">ä¸šåŠ¡æ“ä½œ</span>';
                                if (subIntentName) {
                                    intentText += ' > <span style="color:#52c41a;font-weight:500">' + subIntentName + '</span>';
                                }
                                intentText += ' <span style="color:#999">(' + confidence + '%)</span>';

                                // æ·»åŠ å·¥ä½œæµåç§°ï¼ˆä½¿ç”¨ä¸­æ–‡ï¼‰
                                if (matchedWorkflow) {
                                    const workflowDisplayName = workflowNameMap[matchedWorkflow] || matchedWorkflow;
                                    intentText += ' <span style="color:#722ed1;font-size:12px">â†’ ' + workflowDisplayName + '</span>';
                                }

                                stageEl.innerHTML = '<span class="process-icon" style="color:#52c41a">âœ“</span><span>æ„å›¾è¯†åˆ«: ' + intentText + '</span>';
                            }
                        }
                        break;
                    case 'intent':
                        // å…¼å®¹æ—§çš„å®Œæ•´æ„å›¾äº‹ä»¶
                        const intentEl = ui.assistantLi.querySelector('.intent-status');
                        if (intentEl) {
                            const category = data.intent_category || '';
                            const categoryName = categoryMap[category] || category;
                            const subIntent = data.business_sub_intent || '';
                            const subIntentName = subIntentMap[subIntent] || subIntent;
                            const matchedWorkflow = data.matched_workflow || '';
                            const confidence = Math.round((data.confidence || 0) * 100);

                            let intentText = '';
                            if (category === 'business' && subIntent) {
                                // ä¸šåŠ¡ç±»ï¼šæ˜¾ç¤ºç±»åˆ« > å­æ„å›¾
                                intentText = '<span style="color:#1890ff;font-weight:500">' + categoryName + '</span> > <span style="color:#52c41a;font-weight:500">' + subIntentName + '</span> <span style="color:#999">(' + confidence + '%)</span>';
                            } else {
                                // éä¸šåŠ¡ç±»ï¼šæ˜¾ç¤ºç±»åˆ«åç§°
                                intentText = '<span style="color:#1890ff;font-weight:500">' + categoryName + '</span> <span style="color:#999">(' + confidence + '%)</span>';
                            }

                            intentEl.innerHTML = '<span class="process-icon" style="color:#52c41a">âœ“</span><span>æ„å›¾è¯†åˆ«: ' + intentText + '</span>';
                        }
                        break;
                    case 'rag':
                        // åªæœ‰æ£€ç´¢åˆ°çŸ¥è¯†æ—¶æ‰æ˜¾ç¤º
                        if (data.doc_count && data.doc_count > 0) {
                            const ragDiv = document.createElement('div');
                            ragDiv.className = 'process-item';
                            ragDiv.innerHTML = '<span class="process-icon">ğŸ“š</span><span>æ£€ç´¢åˆ° ' + data.doc_count + ' æ¡ç›¸å…³çŸ¥è¯†</span>';
                            ui.processBody.appendChild(ragDiv);
                        }
                        break;
                    case 'plan':
                        const planDiv = document.createElement('div');
                        planDiv.className = 'process-item';
                        planDiv.innerHTML = '<div style="width:100%"><div style="margin-bottom:5px;color:#666">æ‰§è¡Œè®¡åˆ’:</div><div class="steps-container" style="padding-left:10px"></div></div>';
                        ui.processBody.appendChild(planDiv);
                        const container = planDiv.querySelector('.steps-container');
                        (data.steps || []).forEach((s, index) => {
                            const sEl = document.createElement('div');
                            sEl.className = 'step-item';
                            sEl.setAttribute('data-id', s.step_id);
                            sEl.innerHTML = '<span class="step-dot"></span><span>æ­¥éª¤' + s.step_id + 'ï¼š' + s.description + '</span><span class="step-status"></span>';
                            // ç¬¬ä¸€ä¸ªæ­¥éª¤ç«‹å³å¼€å§‹é—ªçƒ
                            if (index === 0) {
                                sEl.classList.add('active');
                                sEl.querySelector('.step-status').innerHTML = '<div class="loading-spinner-small"></div>';
                            }
                            container.appendChild(sEl);
                        });
                        break;
                    case 'step_start':
                        // step_start äº‹ä»¶ç°åœ¨ä½œä¸ºå¤‡ç”¨ï¼Œä¸»è¦é€»è¾‘åœ¨ plan å’Œ step_end ä¸­å¤„ç†
                        const startEl = ui.assistantLi.querySelector('.step-item[data-id="' + data.step_id + '"]');
                        if (startEl && !startEl.classList.contains('active') && !startEl.classList.contains('completed')) {
                            startEl.classList.add('active');
                            startEl.querySelector('.step-status').innerHTML = '<div class="loading-spinner-small"></div>';
                        }
                        break;
                    case 'step_end':
                        const endEl = ui.assistantLi.querySelector('.step-item[data-id="' + data.step_id + '"]');
                        if (endEl) {
                            endEl.classList.remove('active');
                            endEl.classList.add('completed');
                            endEl.querySelector('.step-status').innerHTML = '<span style="color:#28a745">âœ“</span>';
                            // è®©ä¸‹ä¸€ä¸ªæ­¥éª¤å¼€å§‹é—ªçƒ
                            const nextEl = ui.assistantLi.querySelector('.step-item[data-id="' + (data.step_id + 1) + '"]');
                            if (nextEl && !nextEl.classList.contains('completed')) {
                                nextEl.classList.add('active');
                                nextEl.querySelector('.step-status').innerHTML = '<div class="loading-spinner-small"></div>';
                            }
                        }
                        break;
                    case 'content':
                        if (data.data) {
                            ui.finalAnswer.innerHTML = renderMarkdown(data.data);
                            if (data.page_url) mainContentFrame.src = data.page_url;
                        }
                        break;
                    case 'done':
                        if (ui.executionProcess) ui.executionProcess.classList.add('collapsed');
                        if (ui.processHeaderSpan) ui.processHeaderSpan.textContent = 'æ‰§è¡Œè¿‡ç¨‹ (å·²å®Œæˆ)';
                        scrollToBottom();
                        break;
                    case 'error':
                        ui.finalAnswer.innerHTML = '<div style="color:#ff4d4f">é”™è¯¯: ' + (data.data || 'æœªçŸ¥é”™è¯¯') + '</div>';
                        break;
                }
            }

            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });

            document.getElementById('newChatBtn').addEventListener('click', () => {
                currentConversationId = null;
                logList.innerHTML = '<li class="message-item message-system"><span class="message-text">> å¼€å¯æ–°å¯¹è¯...</span></li>';
                mainContentFrame.src = 'res_module/index.html';
            });

            document.getElementById('historyBtn').addEventListener('click', async () => {
                try {
                    const res = await fetch('/chat/conversations?user_id=user123');
                    const result = await res.json();
                    if (result.success) {
                        historyListContainer.innerHTML = '';
                        (result.data || []).forEach(conv => {
                            const li = document.createElement('li');
                            li.className = 'history-item';
                            li.innerHTML = '<input type="checkbox" class="history-checkbox" data-id="' + conv.id + '"><span class="history-title">' + (conv.title || conv.id) + '</span>';
                            li.querySelector('.history-title').addEventListener('click', () => loadConversation(conv.id));
                            historyListContainer.appendChild(li);
                        });
                        historyModal.style.display = 'flex';
                    }
                } catch (e) {}
            });

            document.getElementById('closeHistory').addEventListener('click', () => { historyModal.style.display = 'none'; });

            document.getElementById('architectureBtn').addEventListener('click', () => {
                window.open('mindmap_classic.html', '_blank');
            });

            async function loadConversation(id) {
                currentConversationId = id;
                historyModal.style.display = 'none';
                logList.innerHTML = '<li class="message-item message-system"><span class="message-text">> æ­£åœ¨åŠ è½½å†å²å¯¹è¯...</span></li>';
                try {
                    const res = await fetch('/chat/conversations/' + id + '/messages');
                    const result = await res.json();
                    if (result.success) {
                        logList.innerHTML = '';
                        result.data.forEach(m => addLog(m.content, m.role === 'user' ? 'user' : 'assistant'));
                    }
                } catch (e) { addLog('> é”™è¯¯: æ— æ³•åŠ è½½å†å²æ¶ˆæ¯'); }
            }
        })();
    </script>
</body>
</html>
