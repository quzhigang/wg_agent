# 水利专业模型-方案新建计算及参数设置相关接口

## 概述

本文档描述了卫共数字孪生流域中与模型方案新建、计算及参数设置相关的API接口，共16个接口。所有接口均基于ASP.NET项目构建，通过Model_Ser.ashx.cs处理。接口地址统一为：<http://172.16.16.253/wg_modelserver/hd_mike11server/Model_Ser.ashx>

---

## 接口列表

### 1. auto_forcast

**用途**: 创建洪水自动预报模型方案并进行计算
**请求方式**: GET
**输入参数**:

- request_type: "auto_forcast"
- request_pars: 空字符串
**输出结果**:
- JSON对象: {"success": true}

### 2. create_model

**用途**: 手工创建模型方案，仅创建方案不设置边界条件，也不计算
**请求方式**: GET
**输入参数**:

- request_type: "create_model"
- request_pars: JSON数组格式: ["model_20230513101926","测试方案1111", "2021/07/20 00:00:00", "2021/07/21 00:00:00","1日模拟",20, base_plan_code]
  - 参数1: 方案ID (plan_code)
  - 参数2: 方案名称 (fangan_name)
  - 参数3: 开始时间 (start_timestr)
  - 参数4: 结束时间 (end_timestr)
  - 参数5: 方案描述 (fangan_desc)
  - 参数6: 结果保存步长(分钟) (step_saveminutes)
  - 参数7: 基础方案ID (base_plan_code)，默认采用空字符串
**输出结果**:
- JSON对象: {"expect_seconds": 预计计算时间(秒)}

### 3. change_model_baseinfo

**用途**: 修改模型方案名称、描述和保存时间步长
**请求方式**: GET
**输入参数**:

- request_type: "change_model_baseinfo"
- request_pars: JSON数组格式: [plan_code, fangan_name, model_desc, step_save_minutes]
  - 参数1: 方案ID (plan_code)
  - 参数2: 新的模型名称 (fangan_name)
  - 参数3: 新的模型描述 (model_desc)
  - 参数4: 保存时间步长(分钟) (step_save_minutes)
**输出结果**:
- JSON对象: {"success": true}

### 4. del_model

**用途**: 删除模型方案,返回剩下的模型方案基础信息集合
**请求方式**: GET
**输入参数**:

- request_type: "del_model"
- request_pars: 方案ID字符串
**输出结果**:
- JSON格式的模型信息字典，格式:{"方案编码1":{"属性1":值1, "属性2":值2, ..}，"方案编码2":{"属性1":值1, "属性2":值2, ..},...}，
  各方案属性相同，为固定的12个属性:
    plan_name(方案名称,varchar)
    plan_desc(方案描述,varchar)
    business_code(业务模型编码,varchar)
    business_name(业务模型名称,varchar)
    start_time(开始时间,varchar)
    end_time(结束时间,varchar)
    state(方案状态,varchar)
    step_save_minutes(模型结果保存时间步长(m),int4)
    expect_seconds(预估计算时长(s),int4)
    start_simulate_time(计算开始时间,varchar)
    progress_info(进度信息,text)
    view_point(相机位置,varchar)

### 5. run_model

**用途**: 计算模型,返回所需的计算时间(second)
**请求方式**: GET
**输入参数**:

- request_type: "run_model"
- request_pars: 方案ID字符串
**输出结果**:
- 字符串: 计算所需的时间(秒)

### 6. run_model_quick

**用途**: 一维快速计算模型(不进行GIS结果后处理),返回所需的计算时间(second)
**请求方式**: GET
**输入参数**:

- request_type: "run_model_quick"
- request_pars: 方案ID字符串
**输出结果**:
- 字符串: 计算所需的时间(秒)

### 7. stop_model

**用途**: 停止模型计算，返回成功信息
**请求方式**: GET
**输入参数**:

- request_type: "stop_model"
- request_pars: 方案ID字符串
**输出结果**:
- JSON对象: {"success": true}

### 8. modify_initial

**用途**: 修改方案的水库河道初始水位条件
**请求方式**: POST
**输入参数**:

- request_type: "modify_initial"
- request_pars: JSON数组格式: [plan_code, "monitor" 或 水位字典]
  - 参数1: 方案ID (plan_code)
  - 参数2: "monitor" (采用监测水位) 或 水位字典JSON
    - 水位字典格式: {"站点ID1": 水位值1, "站点ID2": 水位值2, ...}
**输出结果**:
- JSON对象: {"success": true}

### 9. change_rfmodel

**用途**: 修改方案的各个子流域产汇流模型类型
**请求方式**: POST
**输入参数**:

- request_type: "change_rfmodel"
- request_pars: JSON数组格式: [plan_code, rf_model参数]
  - 参数1: 方案ID (plan_code)
  - 参数2: 产汇流模型参数 (可为空对象或空字符串)，参数json格式: {"子流域编码1": 产汇流模型编码1, "子流域编码2": 产汇流模型编码2, ...}，
  产汇流模型编码，共3种:"nam"、"swmm5"、"xaj"
**输出结果**:
- JSON对象: {"success": true}

### 10. change_boundry

**用途**: 修改方案的洪水入流边界条件，可指定为利用降雨计算洪水，也可直接指定子流域洪水过程，以及指定河道洪水过程或无洪水入流。
**请求方式**: POST
**输入参数**:

- request_type: "change_boundry"
- request_pars: JSON数组格式: [plan_code, bnd_type]或[plan_code, bnd_type, bnd_value]
  - 参数1: 方案ID (plan_code)
  - 参数2: 边界类型: "rf_model"(降雨计算洪水), "reach_inflow"(指定河道洪水), "no_inflow"(无洪水入流), "catchment_inflow"(指定子流域洪水)
  - 参数3: 边界值，当参数2边界类型为 "reach_inflow"或"catchment_inflow"时，需要输入该参数，否则不需要。
          参数2为 "reach_inflow"时，该参数json对象格式: {"边界条件编码1": {"时间1",流量1,"时间2",流量2,...}, "边界条件编码2": {"时间1",流量1,"时间2",流量2,...},...}
          参数2为 "catchment_inflow"时，该参数json对象格式: {"子流域编码1": {"时间1",流量1,"时间2",流量2,...}, "子流域编码2": {"时间1",流量1,"时间2",流量2,...},...}，也可传入位置信息，作为点源，指定河道在该位置的洪水入流过程，如{"jd11409985_wd3544974": {"时间1",流量1,"时间2",流量2,...}}，最好保留经纬度5位小数
**输出结果**:
- JSON对象: {"success": true}

### 11. modify_gatestate

**用途**: 修改方案闸站调度设置
**请求方式**: POST
**输入参数**:

- request_type: "modify_gatestate"
- request_pars: JSON数组格式: [plan_code, "monitor" 或 "gaterule" 或 调度指令数组]
  - 参数1: 方案ID (plan_code)
  - 参数2: 调度方式，共3种值："monitor"、"gaterule"、调度指令数组[]
    - "monitor": 采用当前监测的闸站状态工情
    - "gaterule": 所有闸门采用各闸站设计调度规则进行调度
    - 调度指令数组: 指定各闸门调度方式数组，格式为：[["建筑物编码1",["时间1"，"操作类型1"，"闸孔数","值"]],
      ["建筑物编码2",["时间1"，"操作类型1"，"闸孔数","值"],["时间2"，"操作类型2"，"闸孔数","值"],..], ..]，当时间为空字符串时，表示全过程采用一组闸门操作，闸门状态不再随时间变化，操作类型分为"全开"、"全关"、"半开"、"控泄"、"规则调度"
**输出结果**:
- JSON对象: {"success": true}

### 12. change_reach_break

**用途**: 修改方案河堤溃口设置
**请求方式**: POST
**输入参数**:

- request_type: "change_reach_break"
- request_pars: JSON数组格式: [plan_code, 溃口基本信息JSON]
  - 参数1: 方案ID (plan_code)
  - 参数2: 溃口基本信息JSON对象
    - name: 溃口名称
    - location: [经度, 纬度]
    - fh_width: 溃口宽(米)
    - fh_minutes: 溃堤时长(分钟)
    - break_condition: 溃决时机描述 - "max_level"(河道水位达到最高水位) 或 "set_level"(指定河道水位)
    - break_level: 溃决水位，当break_condition为max_level时，break_level用任意值比如0，否则用指定值
**输出结果**:
- JSON对象: {"success": true}

### 13. set_dispatch_target

**用途**: 设置方案的优化调度目标参数
**请求方式**: POST
**输入参数**:

- request_type: "set_dispatch_target"
- request_pars: JSON数组格式: [plan_code, dd_target, res_level_constraint, other_constraint]
  - 参数1: 方案ID (plan_code)
  - 参数2: 调度目标对象,默认值 {"name": "元村","stcd": "31004300","max_discharge": 2500 }; 3属性分别水文站名称、水文站id、最大允许洪峰流量
  - 参数3: 水库调洪水位约束数组,格式为[{"name": "双泉水库", "stcd": "31006950", "level_name": "防洪高水位", "level_value": 142.3 },{"name": "双泉水库", "stcd": "31006950", "level_name": "防洪高水位", "level_value": 142.3 },..]
  - 参数4: 其他约束对象，默认值{"gate": true,"reach": true,"xzhq_level": true }，3属性分别为闸门过流能力约束、河道过流能力约束、滞洪区滞洪水位约束
**输出结果**:
- JSON对象: {"success": true}

### 14. iter_cal

**用途**: 开始方案的优化迭代计算
**请求方式**: GET
**输入参数**:

- request_type: "iter_cal"
- request_pars: 方案ID字符串
**输出结果**:
- 字符串: 返回计算所需时间(s)

### 15. backcal_resdd

**用途**: 反向推演水库的调度方案和该调度方案下的调蓄结果。需要设置水库允许达到的最高水位，并且只针对已经完成的预报预演方案
**请求方式**: GET
**输入参数**:

- request_type: "backcal_resdd"
- request_pars: JSON数组格式: [plan_code, res_name, max_level]
  - 参数1: 方案ID (plan_code)
  - 参数2: 水库名称 (res_name)
  - 参数3: 允许最高水位 (max_level)
**输出结果**:
- JSON格式的水库调度方案结果信息，包含调度方案以及调度结果，样例：
  {
      "res_name": "盘石头水库",
      "reservoir_result": {          //水库结果信息
          "Stcd": "31005650",        //水库stcd
          "ResName": "盘石头水库",    //水库名称
          "Max_Level": 249.26,       //最高库水位
          "Max_Volumn": 0.0,         //最大库容
          "MaxLevel_Time": "2025/12/10 17:20:53",  //最高水位出现时间
          "Max_InQ": 382.59,          //最大入库流量
          "Max_OutQ": 4.7,           //最大出库流量
          "MaxInQ_Time": "2025/12/10 17:20:53",  //最大入库流量出现时间
          "MaxOutQ_Time": "2025/12/10 17:20:53",  //最大出库流量出现时间
          "Total_InVolumn": 0.0,              //总入库量(万m³)
          "Total_OutVolumn": 0.0,             //总出库量(万m³)
          "YHDTotal_OutVolumn": 0.0,          //溢洪道总出库量(万m³)
          "XHDTotal_OutVolumn": 0.0,          //泄洪洞总出库量
          "EndTime_Level": 0.0,               //最终水位
          "EndTime_Volumn": 0.0,              //最终库容
          "InQ_Dic": {                        //入库流量过程
              "2025/07/15 11:00:00": 16.07,
              "2025/07/15 11:10:00": 16.12,
              //...
              "2025/07/18 11:00:00": 99.04
          },
          "OutQ_Dic": {                       //出库流量过程
              "2025/07/15 11:00:00": 4.7,
              "2025/07/15 11:10:00": 4.7,
              //...
              "2025/07/18 11:00:00": 4.7
          },
          "YHDOutQ_Dic": {},                  //溢洪道出库流量过程
          "XHDOutQ_Dic": {},                  //泄洪洞出库流量过程
          "Level_Dic": {                      //库水位过程
              "2025/07/15 11:00:00": 241.31,
              "2025/07/15 11:10:00": 241.31,
              //...
              "2025/07/18 11:00:00": 249.26
          },
          "Volumn_Dic": {}                   //库容过程
      },
      "is_possible": true,     //调度目标是否能达到
      "dd_desc": "盘石头水库1#泄洪洞自2025/7/16 6:20:00开始控泄流量4.7m³/s; 盘石头水库溢洪道全程关闭。"  //调度方案信息
  }

### 16. set_fault_gate

**用途**: 设置方案的故障闸门
**请求方式**: POST
**输入参数**:

- request_type: "set_fault_gate"
- request_pars: JSON数组格式: [plan_code, fault_dinfo]
  - 参数1: 方案ID (plan_code)
  - 参数2: 故障闸门信息数组，包括：故障水闸编码、故障信息描述、故障闸门编码数组、水闸各闸门开度数组，样例：
          ["QHNZ_XHKJZZ", "部分闸门无法完全关闭", ["XHK_JZZ2", "XHK_JZZ4"],[0,0.5,0,0.2,0]]
**输出结果**:
- JSON对象: {"success": true}

---

## 总结

本文档共收录16个API接口，涵盖了水利专业模型中与方案新建、计算及参数设置相关的所有功能，包括：
- 模型方案的创建、删除和修改（auto_forcast、create_model、change_model_baseinfo、del_model）
- 模型计算控制（run_model、run_model_quick、stop_model）
- 初始条件和边界条件设置（modify_initial、change_rfmodel、change_boundry）
- 闸站和溃口设置（modify_gatestate、change_reach_break、set_fault_gate）
- 优化调度相关（set_dispatch_target、iter_cal、backcal_resdd）
