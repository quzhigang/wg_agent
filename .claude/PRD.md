# 卫共智能体 (wg_agent) - 产品需求文档 (PRD)

## 1. 执行摘要 (Executive Summary)

卫共智能体 (wg_agent) 是一个专门为河南省卫共流域数字孪生系统设计的、基于 **LangGraph** 框架的 **Plan-and-Execute**（计划-执行）智能体系统。其核心目标是为防洪业务提供深度智能化支撑，不仅具备常规的通用对话能力，更能深入理解流域专业知识、调用实时监测数据、并协同各类水利专业模型进行洪水预报预演及预案生成。

**核心价值主张：**

- **专业驱动**：深度集成卫共流域 10大核心知识库以及现有防洪系统的各种水利专业模型服务工具，提供精准的业务问答和业务操作。
- **数据闭环**：通过 175+ 工具链，打通基础数据、监测数据与模型服务的“最后一公里”。
- **交互革命**：引入数字人解说与实时状态播报，消除决策过程中的透明度鸿沟与等待焦灼。
- **全栈产出**：不仅提供答案，更能通过 Office MCP 工具一键导出各类专业报告及多媒体素材。

**MVP 目标：**
交付一个功能齐全的智能体应用程序，包含完整的前后端交互界面，实现“问、查、演、报”四位一体的防洪辅助决策能力。

---

## 2. 最终目标和使命 (Mission)

**产品使命宣言：**
利用 AI 智能体技术，为卫共流域防洪防汛提供“既懂业务、又快响应、且能执行”的可视化数字孪生决策支撑。

**核心原则：**

- **准确性第一**：所有业务结论必须基于真实的监测数据和权威的知识库。
- **任务导向**：系统不应仅止于聊天，更应具备复杂的任务规划与自动化执行能力。
- **交互人性化**：通过数字人和播报员，让复杂的业务流程变得可感知、可理解。
- **操作简易化**：一键生成报告，一键启动模拟，降低专业模型的使用门槛。

---

## 3. 目标用户 (Target Users)

| 用户角色 | 用户特征 | 核心痛点 |
| :--- | :--- | :--- |
| **流域指挥决策者** | 需要根据海量数据快速做判研，对技术底层不敏感。 | 信息过载、数据分散、模拟预演流程复杂、等待反馈时间长。 |
| **水利业务专家** | 具备深厚的专业背景，关注数据源头和模型精度。 | 基础工作重复性高、汇报文档编写耗时。 |
| **系统运维人员** | 负责数字孪生系统的日常维护。 | 业务逻辑复杂，现有系统交互不够友好。 |

---

## 4. 核心功能

### 范围内 (In Scope)

**智能交互层 (Interaction Layer)**

- ✅ **多模态交互**：支持文字输入与数字人自然语言语音问答。
- ✅ **解说员智能体**：并行智能体，实时观测执行状态，解说执行进度并对结果进行概化。
- ✅ **动态 UI**：基于 AIUI 框架和预定义前端页面模板实时生成前端交互组件。

**业务执行层 (Action Layer)**

- ✅ **一般对话 (Chat)**：基础意图分类与快速响应。
- ✅ **RAG 知识问答**：基于 9 大流域知识库的精准检索回答。
- ✅ **水雨情监测**：实时查询流域内监测站点的数据。
- ✅ **防洪业务 (核心)**：洪水预报、防洪预演、防洪预案、灾损评估的全流程自动化。
- ✅ **Python 代码解释器**：动态生成并运行代码，解决复杂计算或临时数据处理需求。

**产出物生成层 (Output Layer)**

- ✅ **Office MCP 工具集**：一键导出 Excel 统计表、Word 报告、PDF 文档、PPT 演示文稿。
- ✅ **多媒体产出**：支持生成 MP4 格式的洪水演进视频或解说视频。
- ✅ **Web 模版库**：丰富的预定义可视化模版，用于展示业务成果。

### 范围外 (Out of Scope)

- ❌ **全自动决策执行**：系统仅提供建议和预案，最终决策仍需人工介入。
- ❌ **大规模实时渲染引擎开发**：借用现有的数字孪生渲染能力，不重复造轮子。

---

## 5. 核心架构与模式 (Core Architecture & Patterns)

### 高层架构 (Plan-and-Execute)

系统采用四节点循环架构，并引入侧边播报机制：

1. **Planner (规划者)**：拆解用户复杂意图为具体任务清单。
2. **Executor (执行者)**：调用 170+ 工具库（API、MCP、Python Interpreter）完成任务。
3. **Controller (控制者)**：汇总执行结果，渲染页面或数字人动作。
4. **Narrator (解说员 - 新增并行节点)**：与执行过程并行，通过消息队列读取 State 变化，实时向前端推送“心跳式”解说。

### 关键目录结构

```text
wg_agent/
├── src/
│   ├── agents/          # Planner, Executor, Controller, Narrator
│   ├── tools/           # 包含 Office MCP, Python Interpreter 等
│   ├── rag/             # 10 大知识库检索逻辑
│   ├── output/          # 各种格式导出逻辑 (PDF/Word/Video)
│   └── workflows/       # 业务逻辑预定义的 DAG
├── PageIndex/           # 向量化数据库系统
└── web/                 # 前端 (数字人组件, AIUI 生成框架)
```

---

## 6. 工具/功能 (Tools/Features)

### 6.1 播报员 (Narrator) Agent 设计

- **用途**：解决长耗时业务（如模型计算）带来的等待冷场。
- **特性**：
  - 状态感知：实时订阅 LangGraph 的 Node 执行事件。
  - 话术生成：将技术语言（如“正在调用模型查询接口”）转化为业务解说（如“正在提取流域未来 24 小时预报雨量，准备进行径流计算”）。
  - 概化讲解：对复杂表格或长文结果进行提炼输出。

### 6.2 Office MCP 集成

- **Word/PDF**：基于模版填充技术，自动生成防洪简报、预案文档。
- **Excel**：将监测数据、预报结果自动转为结构化报表。
- **PPT**：自动抽取核心图表和结论，生成汇报幻灯片。
- **MP4**：获取数值模拟的渲染帧或统计动图，合成解说短视频。

### 6.3 Python 代码执行环境

- **机制**：由 LLM 生成 Python 脚本，通过 Sandboxed Executor 运行。
- **场景**：用于处理现成 API 无法直接满足的复杂数学运算、多源数据交叉分析等。

---

## 7. 技术栈 (Technology Stack)

- **AI 框架**: LangGraph (编排), LangChain (组件)
- **大模型**: 支持混合部署 (国内主流模型 + 闭源大模型)
- **后端**: FastAPI, Python 3.11
- **向量库**: ChromaDB (本地持久化)
- **前端交互**: Vue/React (AIUI 容器), 数字人技术 (Live2D 或 3D 实时驱动)
- **导出工具**: python-docx, openpyxl, reportlab, python-pptx, moviepy

---

## 8. 安全与配置 (Security & Configuration)

- **数据安全**：所有私有业务数据仅在内网环境流转，LLM 调用采用脱敏处理或私有化部署。
- **权限管理**：对接数字孪生系统现有的 RBAC 权限体系。
- **环境隔离**：Python 代码执行必须在受限的沙箱环境中运行。

---

## 9. API 规范 (示例)

### `POST /v1/chat`

- **输入**: 用户文本/语音流、上下文 ID。
- **响应 (流式)**:
  - `type: thought`: 返回 Planner 的思维链。
  - `type: narration`: 返回播报员的实时语音文本。
  - `type: output`: 返回最终渲染组件或文件链接。

---

## 10. 成功标准 (Success Criteria)

- ✅ **响应准确率**：RAG 业务问答准确率达 90% 以上。
- ✅ **意图识别率**：业务意图分类正确率 95% 以上。
- ✅ **用户等待感知**：通过播报员介入，使用户“主观等待感”降低 50%。
- ✅ **文档导出效率**：从得出结论到生成 Word 简报的耗时 < 5 秒。

---

## 11. 实施阶段 (Implementation Phases)

### 阶段 1: 基础夯实 (已完成)

- [x] 智能体 Plan-and-Execute 框架搭建。
- [x] 10 大 RAG 知识库集成。
- [x] 业务情景1简单会话、业务情景2流域固有知识查询和业务情景3中的子业务情景基础监测数据查询工具实现。

### 2. 预报预演等情景3中的子业务意图实现 (进行中)

- [ ] 实现预报预演的预定义流程。
- [ ] 实现预报预演的动态流程实现。
- [ ] 优化细化预报预演业务子意图的逻辑和框架。

### 3. 交互增强 (后续)

- [ ] 接入实时交互数字人 SDK。
- [ ] 开发 Narrator (解说员) 并行 Agent 节点。
- [ ] 优化预报预演业务子意图的逻辑。

### 4. 工具扩展 (后续)

- [ ] 集成 Office MCP 工具集，实现一键导出功能。
- [ ] 开发 Python 代码解释器沙箱环境。
- [ ] 扩充 Web 可视化模版库。

### 5. 全面集成 (远景)

- [ ] 引入 AIUI 前端实时生成框架。
- [ ] 与河南省数字孪生系统主平台深度耦合。

---

## 12. 未来考虑因素 (Future Considerations)

- **自学习能力**：基于用户反馈自动优化工作流规划策略。
- **多智能体博弈**：模拟复杂防洪调度场景下的防指成员会态决策过程。
- **边缘侧部署**：为移动端指令和交互提供轻量化模型支持。

---

## 13. 风险与缓解 (Risks & Mitigations)

- **模型幻觉风险**：在关键数值输出中引入多重复核机制，不直接信任 LLM 生成的数字。
- **性能瓶颈**：长链路执行带来的延迟，通过播报员反馈和异步任务处理缓解。
- **代码执行安全**：严格限制代码解释器的可访问库和文件系统权限。

---

## 14. 附录 (Appendix)

- **参考文档**：`CLAUDE.md`, `README.md`
- **API 列表**：见开发手册 `api_docs_v1.pdf`
- **项目结构图**：`work_flow.md`
