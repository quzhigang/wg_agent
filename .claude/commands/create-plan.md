---
description: "通过深度的代码库分析和研究，创建全面的功能实施计划，使用中文"
---

# 计划新任务 (Plan a new task)

## 功能 (Feature): $ARGUMENTS

## 使命 (Mission)

通过系统的代码库分析、外部研究和战略规划，将功能请求转化为一份**全面的实施计划**。

**核心原则**：在此阶段我们**不进行**编码。我们的目标是创建一份包含丰富上下文信息的实施计划，以确保 AI 代理能够一次性成功实施。

**核心理念**：内容 (Context) 胜于一切。该计划必须包含实施所需的 **所有** 信息——模式 (Patterns)、必读材料、文档、验证命令——以便执行代理能够首次尝试即告成功。

## 规划流程 (Planning Process)

### 第一阶段：理解功能 (Feature Understanding)

**深度功能分析：**

- 提取待解决的核心问题
- 识别用户价值和业务影响
- 确定功能类型：新功能 / 增强 / 重构 / 漏洞修复
- 评估复杂度：低 / 中 / 高
- 映射受影响的系统和组件

**创建或完善用户故事格式 (如果用户已提供故事，则进行细化)：**

```
作为一个 <用户类型>
我想要 <执行的操作/达到的目标>
以便 <获得收益/发挥价值>
```

### 第二阶段：代码库情报搜集 (Codebase Intelligence Gathering)

**利用专门的代理进行并行分析：**

**1. 项目结构分析**

- 检测主要语言、框架及其运行时版本
- 映射目录结构和架构模式
- 识别服务/组件边界及集成点
- 定位配置文件 (pyproject.toml, package.json 等)
- 查找环境设置和构建流程

**2. 模式识别 (Pattern Recognition)** (在有益时使用专门的子代理)

- 在代码库中搜索类似的实现
- 识别编码规范：
  - 命名模式 (CamelCase, snake_case, kebab-case)
  - 文件组织和模块结构
  - 错误处理方式
  - 日志记录模式与标准
- 提取功能所属领域的通用模式
- 记录应当避免的反面模式 (Anti-patterns)
- 查看 `CLAUDE.md` 以获取项目特定的规则和规范

**3. 依赖分析 (Dependency Analysis)**

- 编目与该功能相关的外部库
- 了解库是如何集成的 (核查 import 语句和配置)
- 在 `docs/`、`ai_docs/`、`.claude/reference` 或 `ai-wiki` (如果存在) 中查找相关文档
- 记录库的版本及兼容性要求

**4. 测试模式 (Testing Patterns)**

- 识别测试框架和结构 (pytest, jest 等)
- 查找类似的测试示例作为参考
- 了解测试组织方式 (单元测试 vs 集成测试)
- 记录覆盖率要求和测试标准

**5. 集成点 (Integration Points)**

- 确定现有需要更新的文件
- 确定需要新建的文件及其存放位置
- 映射 router/API 注册模式
- 了解数据库/模型模式 (如果适用)
- 识别身份验证/授权模式 (如果相关)

**澄清歧义：**

- 如果此时需求尚不明确，请在继续之前要求用户澄清
- 获取具体的实施偏好 (库、方法、模式)
- 在继续之前解决架构决策问题

### 第三阶段：外部研究与文档 (External Research & Documentation)

**在进行外部研究时，若有益处，可使用专门的子代理：**

**搜集文档：**

- 研究库的最新版本和最佳实践
- 找到带有特定小节锚点的官方文档
- 定位实施示例和教程
- 识别常见的陷阱和已知问题
- 查看破坏性变更 (Breaking changes) 和迁移指南

**技术趋势：**

- 研究该技术栈当前的最佳实践
- 查找相关的博客文章、指南或案例研究
- 识别性能优化模式
- 记录安全方面的考虑

**汇编研究参考文献：**

```markdown
## 相关文档 (Relevant Documentation)

- [库官方文档](https://example.com/docs#section)
  - 特定功能实施指南
  - 原因：实现 X 功能所需
- [框架指南](https://example.com/guide#integration)
  - 集成模式章节
  - 原因：展示如何连接各组件
```

### 第四阶段：深度战略思考 (Deep Strategic Thinking)

**深入思考以下问题：**

- 该功能如何融入现有架构？
- 关键依赖项和操作顺序是什么？
- 哪里可能会出问题？ (边缘情况、竞态条件、错误)
- 如何进行全面的测试？
- 存在哪些性能影响？
- 是否涉及安全方面的考虑？
- 该方法的可维护性如何？

**设计决策：**

- 在备选方案中做出选择，并给出明确的理由
- 针对可扩展性和未来的修改进行设计
- 如果需要，规划向后兼容性
- 考虑扩展性 (Scalability) 的影响

### 第五阶段：生成计划结构 (Plan Structure Generation)

**按照以下结构创建全面的计划：**

以下是供您为执行代理填充的模板：

```markdown
# 功能 (Feature): <功能名称>

以下计划应当是完整的，但在开始实施之前，请务必验证文档、代码库模式以及任务的合理性。

特别注意现有 utils、types 和 models 的命名。确保从正确的文件进行导入等。

## 功能描述 (Feature Description)

<关于该功能的详细描述、用途以及对用户的价值>

## 用户故事 (User Story)

作为一个 <用户类型>
我想要 <执行操作/达到目标>
以便 <获得收益/发挥价值>

## 问题陈述 (Problem Statement)

<清晰地定义该功能所解决的具体问题或机遇>

## 解决方案陈述 (Solution Statement)

<描述提议的解决思路以及它如何解决问题>

## 功能元数据 (Feature Metadata)

**功能类型**: [新功能/增强/重构/漏洞修复]
**估计复杂度**: [低/中/高]
**主要受影响系统**: [主要组件/服务列表]
**依赖项**: [所需的外部库或服务]

---

## 上下文参考 (CONTEXT REFERENCES)

### 相关代码库文件 (重要：实施前必须阅读这些文件！)

<列出文件及其行号和相关性>

- `path/to/file.py` (第 15-45 行) - 原因：包含我们将效仿的 X 模式
- `path/to/model.py` (第 100-120 行) - 原因：需要遵循的数据库模型结构
- `path/to/test.py` - 原因：测试模式示例

### 待新建文件

- `path/to/new_service.py` - X 功能的服务实现
- `path/to/new_model.py` - Y 资源的属性模型
- `tests/path/to/test_new_service.py` - 新服务的单元测试

### 相关文档 (实施前应当阅读！)

- [文档链接 1](https://example.com/doc1#section)
  - 特定章节：身份验证设置
  - 原因：实施安全终端节点所需
- [文档链接 2](https://example.com/doc2#integration)
  - 特定章节：数据库集成
  - 原因：展示了正确的异步数据库模式

### 需遵循的模式

<从代码库提取的特定模式 - 包含项目中的实际代码示例>

**命名规范：** (例如)

**错误处理：** (例如)

**日志记录模式：** (例如)

**其他相关模式：** (例如)

---

## 实施计划 (IMPLEMENTATION PLAN)

### 第一阶段：基础构建

<描述在主要实施前所需的基础工作>

**任务：**

- 设置基础结构 (schemas, types, interfaces)
- 配置必要的依赖项
- 创建基础工具类或辅助函数

### 第二阶段：核心实施

<描述主要的实施工作内容>

**任务：**

- 实施核心业务逻辑
- 创建服务层组件
- 添加 API 终端节点或接口
- 实施数据模型

### 第三阶段：集成

<描述该功能如何与现有功能集成>

**任务：**

- 连接到现有的 routers/handlers
- 注册新组件
- 更新配置文件
- 根据需要添加中间件或拦截器

### 第四阶段：测试与验证

<描述测试方法>

**任务：**

- 为每个组件实施单元测试
- 为功能工作流创建集成测试
- 添加边缘情况测试
- 根据验收标准进行验证

---

## 分步任务 (STEP-BY-STEP TASKS)

重要：请按顺序自上而下执行每个任务。每个任务都应当是原子的且可以独立测试。

### 任务格式指南

使用信息密集的关键字以确保清晰：

- **CREATE**: 创建新文件或组件
- **UPDATE**: 修改现有文件
- **ADD**: 在现有代码中插入新功能
- **REMOVE**: 删除弃用的代码
- **REFACTOR**: 在不改变行为的情况下重构结构
- **MIRROR**: 从代码库其他位置复制模式

### {ACTION} {target_file}

- **IMPLEMENT**: {具体实施细节}
- **PATTERN**: {参考的现有模式 - file:line}
- **IMPORTS**: {所需的导入项和依赖}
- **GOTCHA**: {已知的问题或需避免的限制}
- **VALIDATE**: `{可执行的验证命令}`

<按照依赖顺序继续后续所有任务...>

---

## 测试策略 (TESTING STRATEGY)

<基于项目的测试框架以及在研究中发现的模式定义测试方法>

### 单元测试 (Unit Tests)

<基于项目标准的范围和要求>

仿照现有的测试方法，使用 fixtures 和 assertions 设计单元测试。

### 集成测试 (Integration Tests)

<基于项目标准的范围和要求>

### 边缘情况 (Edge Cases)

<列出该功能必须测试的具体边缘情况>

---

## 验证命令 (VALIDATION COMMANDS)

<基于在第二阶段发现的项目工具定义验证命令>

执行每个命令以确保零回归并达到 100% 的功能正确性。

### 第一级：语法与风格

<项目特定的 linting 和格式化命令>

### 第二级：单元测试

<项目特定的单元测试命令>

### 第三级：集成测试

<项目特定的集成测试命令>

### 第四级：手动验证

<功能特定的手动测试步骤 - API 调用、UI 测试等>

### 第五级：额外验证 (可选)

<MCP 服务器或额外的 CLI 工具 (如果可用)>

---

## 验收标准 (ACCEPTANCE CRITERIA)

<列出完成任务必须满足的具体、可衡量的标准>

- [ ] 功能实现了所有指定的特性
- [ ] 所有验证命令均以零错误通过
- [ ] 单元测试覆盖率符合要求 (80%+)
- [ ] 集成测试验证了端到端工作流
- [ ] 代码遵循项目规范和模式
- [ ] 现有功能没有出现回归
- [ ] (如果适用) 已更新文档
- [ ] (如果适用) 性能符合要求
- [ ] (如果适用) 已解决安全考虑

---

## 完成清单 (COMPLETION CHECKLIST)

- [ ] 所有任务按顺序完成
- [ ] 每个任务验证都立即通过
- [ ] 所有验证命令执行成功
- [ ] 完整测试套件通过 (单元测试 + 集成测试)
- [ ] 无 linting 或类型检查错误
- [ ] 手动测试确认功能正常
- [ ] 验收标准全部达成
- [ ] 代码质量和可维护性已通过审查

---

## 备注 (NOTES)

<额外的上下文、设计决策、权衡>
```

## 输出格式 (Output Format)

**文件名**: `.claude/plans/{用连字符分隔的描述性名称}.md`

- 将 `{用连字符分隔的描述性名称}` 替换为简短、具有描述性的功能名称
- 示例：`add-user-authentication.md`, `implement-search-api.md`, `refactor-database-layer.md`

**目录**: 如果 `.claude/plans/` 不存在，请创建它

## 质量标准 (Quality Criteria)

### 上下文完整性 (Context Completeness) ✓

- [ ] 已识别并记录所有必要的模式
- [ ] 提供了带有链接的外部库使用文档
- [ ] 集成点映射清晰
- [ ] 捕捉到了陷阱和反面模式
- [ ] 每个任务都有可执行的验证命令

### 准备就绪 (Implementation Ready) ✓

- [ ] 另一位开发者无需额外上下文即可执行
- [ ] 任务按依赖关系排序 (可以自上而下执行)
- [ ] 每个任务都是原子的，可以独立测试
- [ ] 模式参考包含了具体的 file:line 行号

### 模式一致性 (Pattern Consistency) ✓

- [ ] 任务遵循现有的代码库规范
- [ ] 新模式理由充分且明确
- [ ] 未重新发明现有的模式或实用工具 (utils)
- [ ] 测试方法符合项目标准

### 信息密度 (Information Density) ✓

- [ ] 无泛泛的参考 (全部具体且可操作)
- [ ] (如果适用) URL 包含了章节锚点
- [ ] 任务描述使用了代码库关键字
- [ ] 验证命令为非交互式的可执行命令

## 成功指标 (Success Metrics)

**一站式实施 (One-Pass Implementation)**：执行代理无需额外的研究或澄清即可完成功能。

**验证完备**：每个任务至少有一个运行良好的验证命令。

**上下文丰富**：计划通过了“无先验知识测试”——不熟悉代码库的人仅凭计划内容即可完成实施。

**信心分数**：关于首次尝试即能成功的信心评分为 #/10。

## 报告 (Report)

创建计划后，请提供：

- 功能及方法的摘要
- 所创建计划文件的完整路径
- 复杂度评估
- 关键实施风险或考虑因素
- 首次尝试成功的预计信心分数
