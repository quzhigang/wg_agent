                                用户消息
                                  │
                                  ▼
┌───────────────────────────────────┐
│                           PLAN 节点 (planner_node)                   │
│  ┌───────────────────────────────┐  │
│  │ 1. 意图分析 (analyze_intent)                                 │  │
│  │    - 调用LLM分析用户意图                                     │  │
│  │    - 如果是general_chat，直接生成回复                        │  │
│  ├───────────────────────────────┤  │
│  │ 2. 工作流匹配 (check_workflow_match)                         │  │
│  │    - 检查是否匹配预定义工作流                                │  │
│  ├───────────────────────────────┤  │
│  │ 3. 计划生成 (generate_plan) ← 仅当无匹配工作流时执行        │  │
│  │    ├── 3.1 RAG检索，获取相关知识和业务流程                │  │
│  │    ├── 3.2 获取可用工具描述                               │  │
│  │    ├── 3.3 获取可用工作流描述                             │  │
│  │    └── 3.4 LLM生成执行计划（参考RAG检索结果）             │  │
│  └───────────────────────────────┘  │
└───────────────────────────────────┘
                                  │
                                  ▼
                         plan_router 路由函数
                    ┌────────────┐
                    │          │            │
                    ▼          ▼            ▼
            ┌─────┐ ┌────┐ ┌─────┐
            │quick_chat│ │  rag   │ │ workflow │
            │   节点   │ │  节点  │ │ 节点     │
            └─────┘ └────┘ └─────┘
                  │            │            │
                  ▼            │            │
                 END            │            │
                                ▼            ▼
                    ┌─────────────┐
                    │     EXECUTE 节点         │
                    │   (executor_node)        │
                    │   执行计划中的各步骤     │
                    │   调用工具（API接口）    │
                    └─────────────┘
                                │
                                ▼
                       should_continue 路由
              ┌────┬────┬────┬────┐
              │        │        │        │        │
              ▼        ▼        ▼        ▼        ▼
          execute  wait_async  respond     plan      END
          (继续)   (等待异步)   (响应)   (重规划)
              │        │        │
              │        ▼        │
              │   ┌─────┐ │  
              │   │wait_async│ │
              │   │   节点   │ │ 
              │   └─────┘ │ 
              │        │        │
              │        ▼        │
              │  ┌────────────┐
              └► │     RESPOND 节点       │
                  │   (controller_node)    │
                  │   合成最终响应文本     │
                  │   可能生成Web页面      │
                  └────────────┘
                              │
                              ▼
                             END
