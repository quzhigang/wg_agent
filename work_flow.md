                                用户提问
                                   │
                                   ▼
┌────────────────────────────────────────────────────────────────┐
│                    PLAN 节点 (planner_node)                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. 意图分析 (analyze_intent) - 三大类分类                 │  │
│  │    ├── 第1类: chat (一般对话/闲聊)                        │  │
│  │    ├── 第2类: knowledge (固有知识查询)                    │  │
│  │    └── 第3类: business (业务相关)                         │  │
│  │         └── 子意图: data_query/flood_forecast/            │  │
│  │                    flood_simulation/emergency_plan/       │  │
│  │                    damage_assessment/other                │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │ 2. 工作流匹配 (check_workflow_match) ← 仅business类执行    │  │
│  │    ├── 2.1 向量检索匹配预定义工作流模板                     │  │
│  │    ├── 2.2 静态映射匹配（备选）                             │  │
│  │    └── 2.3 匹配自动保存的流程 (_match_saved_workflow)       │  │
│  ├────────────────────────────────────────────────────────────┤  │
│  │ 3. 计划生成 (generate_plan) ← 仅当无匹配工作流时执行         │  │
│  │    ├── 3.1 RAG检索，获取相关知识和业务流程                   │  │
│  │    ├── 3.2 获取可用工具描述                                 │  │
│  │    ├── 3.3 获取可用工作流描述                               │  │
│  │    ├── 3.4 LLM生成执行计划                                  │  │
│  │    └── 3.5 自动保存动态流程 (_save_dynamic_plan)            │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                          plan_router 路由函数
               ┌───────────┬───────────┬───────────┐
               │           │           │           │
               ▼           ▼           ▼           ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
        │quick_chat│ │knowledge │ │ workflow │ │ execute  │
        │   节点   │ │_rag 节点  │ │   节点   │ │   节点   │
        └──────────┘ └──────────┘ └──────────┘ └──────────┘
               │           │           │           │
               ▼           │           │           │
              END          │           │           │
                           ▼           ▼           ▼
                    ┌─────────────────────────────────┐
                    │         EXECUTE 节点            │
                    │       (executor_node)           │
                    │     执行计划中的各步骤          │
                    │     调用工具（API接口）         │
                    └─────────────────────────────────┘
                                   │
                                   ▼
                          should_continue 路由
             ┌────────┬────────┬────────┬────────┐
             │        │        │        │        │
             ▼        ▼        ▼        ▼        ▼
         execute  wait_async respond    plan     END
         (继续)   (等待异步)  (响应)    (重规划)
             │        │        │
             │        ▼        │
             │  ┌──────────┐   │
             │  │wait_async│   │
             │  │   节点   │   │
             │  └──────────┘   │
             │        │        │
             │        ▼        │
             │  ┌─────────────────────────────────┐
             └► │        RESPOND 节点             │
                │      (controller_node)          │
                │      合成最终响应文本           │
                │      可能生成Web页面            │
                └─────────────────────────────────┘
                                │
                                ▼
                               END


═══════════════════════════════════════════════════════════════════
                        三大类意图分类说明
═══════════════════════════════════════════════════════════════════

第1类: chat (一般对话)
├── 问候、感谢、告别、闲聊
├── 询问助手信息
└── 流程: plan → quick_chat → END

第2类: knowledge (固有知识查询)
├── 9个知识库: catchment_basin, water_project, monitor_site,
│              history_flood, flood_preplan, system_function,
│              hydro_model, catchment_planning, project_designplan
└── 流程: plan → knowledge_rag → mcp搜索(特定问题或RAG匹配度低时) → respond → END

第3类: business (业务相关)
├── 子意图: data_query, flood_forecast, flood_simulation,
│          emergency_plan, damage_assessment, other
├── 匹配优先级:
│   1. 预定义工作流模板（向量检索，置信度≥0.75）
│   2. 静态映射（子意图→工作流）
│   3. 自动保存的流程（按使用次数排序）
│   4. 动态规划（LLM生成）→ 自动保存
└── 流程: plan → [workflow/execute] → respond → END


═══════════════════════════════════════════════════════════════════
                      自动保存流程机制
═══════════════════════════════════════════════════════════════════

触发条件:
├── 动态规划成功生成计划
├── 计划步骤数 >= 2
└── 意图类别为 business

保存内容:
├── 流程名称（auto_{sub_intent}_{随机ID}）
├── 触发模式（用户消息特征）
├── 意图类别和子意图
├── 实体提取模式
├── 完整执行步骤（JSON）
└── 输出类型

匹配逻辑:
├── 按子意图筛选已保存流程
├── 按使用次数降序排序
├── 匹配成功后自动增加使用次数
└── 支持启用/禁用控制

管理接口:
├── GET  /saved-workflows          获取清单
├── GET  /saved-workflows/{id}     获取详情
├── PUT  /saved-workflows/{id}     编辑流程
├── DELETE /saved-workflows/{id}   删除流程
└── PATCH /saved-workflows/{id}/toggle  启用/禁用

管理页面: /ui/saved_workflows.html
